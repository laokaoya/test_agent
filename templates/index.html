<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>儿童AI对话测试平台</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .card {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border: none;
            margin-bottom: 20px;
        }
        .card-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
        }
        .btn-primary:hover {
            background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
        }
        .result-card {
            border-left: 4px solid #28a745;
        }
        .score-badge {
            font-size: 1.2em;
            padding: 8px 16px;
        }
        .loading {
            display: none;
        }
        .child-card {
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }
        .child-card:hover {
            border-color: #667eea;
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.2);
        }
        .criteria-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- 左侧配置面板 -->
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h4><i class="fas fa-cog"></i> 测试配置</h4>
                    </div>
                    <div class="card-body">
                        <!-- 测试角色配置 -->
                        <h5><i class="fas fa-child"></i> 测试角色</h5>
                        <div id="children-container">
                            <!-- 默认角色将自动加载 -->
                        </div>
                        <div class="d-flex gap-2 mb-3">
                            <button class="btn btn-outline-primary btn-sm" onclick="addChild()">
                                <i class="fas fa-plus"></i> 添加自定义角色
                            </button>
                            <div class="dropdown">
                                <button class="btn btn-primary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                    <i class="fas fa-user-plus"></i> 快速添加内置角色
                                </button>
                                <ul class="dropdown-menu" id="preset-children-menu">
                                    <li><a class="dropdown-item text-muted" href="#">加载中...</a></li>
                                </ul>
                            </div>
                        </div>

                        <!-- 评分标准配置 -->
                        <h5 class="mt-4"><i class="fas fa-chart-line"></i> 评分标准</h5>
                        <div id="criteria-container">
                            <!-- 默认评分标准将自动加载 -->
                        </div>
                        <div class="d-flex gap-2 mb-3">
                            <button class="btn btn-outline-primary btn-sm" onclick="addCriteria()">
                                <i class="fas fa-plus"></i> 添加自定义标准
                            </button>
                            <div class="dropdown">
                                <button class="btn btn-success btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                    <i class="fas fa-star"></i> 快速添加内置标准
                                </button>
                                <ul class="dropdown-menu" id="preset-criteria-menu">
                                    <li><a class="dropdown-item text-muted" href="#">加载中...</a></li>
                                </ul>
                            </div>
                        </div>

                        <!-- 操作按钮 -->
                        <div class="d-grid gap-2 mt-4">
                            <button class="btn btn-primary" onclick="runTest()">
                                <i class="fas fa-play"></i> 开始测试
                            </button>
                            <button class="btn btn-warning" onclick="clearResults()">
                                <i class="fas fa-trash"></i> 清空结果
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 右侧结果面板 -->
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h4 class="mb-0"><i class="fas fa-chart-bar"></i> 测试结果</h4>
                        <button class="btn btn-outline-light btn-sm" data-bs-toggle="modal" data-bs-target="#settingsModal">
                            <i class="fas fa-cog"></i> 设置
                        </button>
                    </div>
                    <div class="card-body">
                        <!-- 加载状态 -->
                        <div class="loading text-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">测试中...</span>
                            </div>
                            <p class="mt-2">正在运行测试，请稍候...</p>
                        </div>

                        <!-- 结果展示 -->
                        <div id="results-container">
                            <div class="text-center text-muted">
                                <i class="fas fa-clipboard-list fa-3x mb-3"></i>
                                <p>配置测试角色和评分标准，然后点击"开始测试"</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 设置模态弹窗 -->
    <div class="modal fade" id="settingsModal" tabindex="-1" aria-labelledby="settingsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="settingsModalLabel">
                        <i class="fas fa-cog"></i> 高级设置
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- API密钥配置 -->
                    <h5 class="mb-3"><i class="fas fa-key"></i> API密钥配置</h5>
                    <div class="card mb-4">
                        <div class="card-body">
                            <div class="mb-3">
                                <label for="dify-api-key" class="form-label">
                                    <strong>Dify API Key</strong>
                                    <small class="text-muted">(可选，留空使用默认配置)</small>
                                </label>
                                <div class="input-group">
                                    <input type="password" class="form-control" id="dify-api-key" placeholder="留空使用默认密钥">
                                    <button class="btn btn-outline-secondary" type="button" onclick="togglePasswordVisibility('dify-api-key')">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                                <small class="form-text text-muted">用于连接Dify Agent</small>
                            </div>
                            <div class="mb-0">
                                <label for="gemini-api-key" class="form-label">
                                    <strong>Gemini API Key</strong>
                                    <small class="text-muted">(可选，留空使用默认配置)</small>
                                </label>
                                <div class="input-group">
                                    <input type="password" class="form-control" id="gemini-api-key" placeholder="留空使用默认密钥">
                                    <button class="btn btn-outline-secondary" type="button" onclick="togglePasswordVisibility('gemini-api-key')">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                                <small class="form-text text-muted">用于生成孩子回复和评分</small>
                            </div>
                        </div>
                    </div>

                    <!-- 对话轮数设置 -->
                    <h5 class="mb-3"><i class="fas fa-sync-alt"></i> 对话轮数设置</h5>
                    <div class="card mb-3">
                        <div class="card-body">
                            <label for="rounds-input" class="form-label">
                                <strong>每个角色测试轮数</strong>
                            </label>
                            <input type="number" class="form-control" id="rounds-input" min="1" max="10" value="3">
                            <small class="form-text text-muted">建议1-10轮，默认3轮。轮数越多，对话越深入，但测试时间也越长。</small>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> 关闭
                    </button>
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">
                        <i class="fas fa-check"></i> 保存设置
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 切换密码可见性
        function togglePasswordVisibility(inputId) {
            const input = document.getElementById(inputId);
            const button = input.nextElementSibling;
            const icon = button.querySelector('i');
            
            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                input.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        }
        
        // 获取用户设置的API密钥
        function getApiKeys() {
            const difyKey = document.getElementById('dify-api-key').value.trim();
            const geminiKey = document.getElementById('gemini-api-key').value.trim();
            
            return {
                dify_api_key: difyKey || null,  // 如果为空，后端使用默认值
                gemini_api_key: geminiKey || null
            };
        }
        
        // 获取用户设置的对话轮数
        function getRounds() {
            return parseInt(document.getElementById('rounds-input').value) || 3;
        }
        
        // 内置角色数据（从API加载）
        let presetChildren = {};
        // 已添加的角色ID集合
        let addedChildrenIds = new Set();

        // 从API加载内置角色数据
        async function loadPresetChildren() {
            try {
                const response = await fetch('/api/preset-children');
                if (response.ok) {
                    presetChildren = await response.json();
                    updatePresetChildrenMenu();
                    console.log('✅ 内置角色加载成功:', Object.keys(presetChildren).length, '个角色');
                    
                    // 自动添加第一个预设角色作为默认角色
                    const firstPresetId = Object.keys(presetChildren)[0];
                    if (firstPresetId) {
                        addPresetChild(firstPresetId);
                        addedChildrenIds.add(firstPresetId);
                        console.log('✅ 已自动添加默认角色:', presetChildren[firstPresetId].name);
                        // 更新菜单以排除已添加的角色
                        updatePresetChildrenMenu();
                    }
                } else {
                    console.error('❌ 加载内置角色失败:', response.status);
                }
            } catch (error) {
                console.error('❌ 加载内置角色异常:', error);
            }
        }

        // 更新内置角色下拉菜单
        function updatePresetChildrenMenu() {
            const menu = document.getElementById('preset-children-menu');
            if (!menu) return;
            
            menu.innerHTML = '';
            
            // 过滤掉已添加的角色
            const availableChildren = Object.entries(presetChildren).filter(([id, child]) => !addedChildrenIds.has(id));
            
            if (availableChildren.length === 0) {
                menu.innerHTML = '<li><a class="dropdown-item text-muted" href="#">所有角色已添加</a></li>';
                return;
            }
            
            // 动态生成菜单项（只显示未添加的角色）
            for (const [id, child] of availableChildren) {
                const menuItem = document.createElement('li');
                menuItem.innerHTML = `
                    <a class="dropdown-item" href="#" onclick="addPresetChild('${id}'); return false;">
                        ${child.emoji || '🧒'} ${child.name} - ${child.type || '测试型'}
                    </a>
                `;
                menu.appendChild(menuItem);
            }
        }

        // 内置评分标准数据（从API加载）
        let presetCriteria = {};
        // 已添加的评分标准ID集合
        let addedCriteriaIds = new Set();

        // 从API加载内置评分标准数据
        async function loadPresetCriteria() {
            try {
                const response = await fetch('/api/preset-criteria');
                if (response.ok) {
                    presetCriteria = await response.json();
                    updatePresetCriteriaMenu();
                    console.log('✅ 内置评分标准加载成功:', Object.keys(presetCriteria).length, '个标准');
                    
                    // 自动添加前三个预设评分标准作为默认标准
                    const criteriaIds = Object.keys(presetCriteria);
                    const defaultCriteriaCount = Math.min(3, criteriaIds.length);
                    for (let i = 0; i < defaultCriteriaCount; i++) {
                        addPresetCriterion(criteriaIds[i]);
                        addedCriteriaIds.add(criteriaIds[i]);
                    }
                    console.log(`✅ 已自动添加默认评分标准: ${defaultCriteriaCount} 个`);
                    // 更新菜单以排除已添加的标准
                    updatePresetCriteriaMenu();
                } else {
                    console.error('❌ 加载内置评分标准失败:', response.status);
                }
            } catch (error) {
                console.error('❌ 加载内置评分标准异常:', error);
            }
        }

        // 更新内置评分标准下拉菜单
        function updatePresetCriteriaMenu() {
            const menu = document.getElementById('preset-criteria-menu');
            if (!menu) return;
            
            menu.innerHTML = '';
            
            // 过滤掉已添加的标准
            const availableCriteria = Object.entries(presetCriteria).filter(([id, criterion]) => !addedCriteriaIds.has(id));
            
            if (availableCriteria.length === 0) {
                menu.innerHTML = '<li><a class="dropdown-item text-muted" href="#">所有标准已添加</a></li>';
                return;
            }
            
            // 动态生成菜单项（只显示未添加的标准）
            for (const [id, criterion] of availableCriteria) {
                const menuItem = document.createElement('li');
                menuItem.innerHTML = `
                    <a class="dropdown-item" href="#" onclick="addPresetCriterion('${id}'); return false;">
                        ⭐ ${criterion.name}
                    </a>
                `;
                menu.appendChild(menuItem);
            }
        }

        // 添加预设评分标准
        function addPresetCriterion(criterionId) {
            const criterion = presetCriteria[criterionId];
            if (!criterion) return;
            
            // 防止重复添加
            if (addedCriteriaIds.has(criterionId)) {
                console.log('⚠️ 评分标准已存在，不重复添加:', criterion.name);
                return;
            }
            
            const container = document.getElementById('criteria-container');
            const criteriaItem = document.createElement('div');
            criteriaItem.className = 'criteria-item';
            criteriaItem.setAttribute('data-criterion-id', criterionId); // 保存ID用于删除时识别
            criteriaItem.innerHTML = `
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <input type="text" class="form-control form-control-sm" style="width: 70%;" placeholder="评分标准名称" value="${criterion.name}">
                    <button class="btn btn-sm btn-outline-danger" onclick="removeCriteria(this)"><i class="fas fa-trash"></i></button>
                </div>
                <textarea class="form-control" rows="5" placeholder="描述如何评估这个标准...">${criterion.prompt}</textarea>
            `;
            container.appendChild(criteriaItem);
            
            // 记录已添加的标准ID
            addedCriteriaIds.add(criterionId);
            // 更新菜单，排除已添加的标准
            updatePresetCriteriaMenu();
        }

        // 页面加载时自动加载内置角色和评分标准
        document.addEventListener('DOMContentLoaded', function() {
            loadPresetChildren();
            loadPresetCriteria();
        });

        // 添加预设角色
        function addPresetChild(presetId) {
            const preset = presetChildren[presetId];
            if (!preset) return;
            
            // 防止重复添加
            if (addedChildrenIds.has(presetId)) {
                console.log('⚠️ 角色已存在，不重复添加:', preset.name);
                return;
            }
            
            const container = document.getElementById('children-container');
            const childCard = document.createElement('div');
            childCard.className = 'child-card';
            childCard.setAttribute('data-preset-id', presetId); // 保存ID用于删除时识别
            childCard.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <input type="text" class="form-control mb-2" placeholder="姓名" value="${preset.name}">
                    </div>
                    <div class="col-md-6">
                        <input type="number" class="form-control mb-2" placeholder="年龄" value="${preset.age}">
                    </div>
                </div>
                <textarea class="form-control mb-2" placeholder="性格特点" rows="4">${preset.traits}</textarea>
                <textarea class="form-control mb-2" placeholder="开场白" rows="2">${preset.opening}</textarea>
                <button class="btn btn-sm btn-danger" onclick="removeChildCard(this)"><i class="fas fa-trash"></i> 删除</button>
            `;
            container.appendChild(childCard);
            
            // 记录已添加的角色ID
            addedChildrenIds.add(presetId);
            // 更新菜单，排除已添加的角色
            updatePresetChildrenMenu();
        }
        
        // 添加自定义测试角色
        function addChild() {
            const container = document.getElementById('children-container');
            const childCard = document.createElement('div');
            childCard.className = 'child-card';
            childCard.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <input type="text" class="form-control mb-2" placeholder="姓名" value="新角色">
                    </div>
                    <div class="col-md-6">
                        <input type="number" class="form-control mb-2" placeholder="年龄" value="8">
                    </div>
                </div>
                <textarea class="form-control mb-2" placeholder="性格特点" rows="4">活泼好动，喜欢运动和游戏。</textarea>
                <textarea class="form-control mb-2" placeholder="开场白" rows="2">你好！我们来玩个游戏吧！</textarea>
                <button class="btn btn-sm btn-danger" onclick="removeChildCard(this)"><i class="fas fa-trash"></i> 删除</button>
            `;
            container.appendChild(childCard);
        }

        // 删除测试角色
        function removeChildCard(button) {
            const childCard = button.closest('.child-card');
            const presetId = childCard.getAttribute('data-preset-id');
            
            if (document.querySelectorAll('.child-card').length > 1) {
                childCard.remove();
                
                // 如果是预设角色，从已添加集合中移除
                if (presetId) {
                    addedChildrenIds.delete(presetId);
                    // 更新菜单，该角色可以再次添加
                    updatePresetChildrenMenu();
                    console.log('✅ 已移除角色:', presetId);
                }
            } else {
                alert('至少需要保留一个测试角色');
            }
        }

        // 添加评分标准
        function addCriteria() {
            const container = document.getElementById('criteria-container');
            const criteriaItem = document.createElement('div');
            criteriaItem.className = 'criteria-item';
            criteriaItem.innerHTML = `
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <input type="text" class="form-control form-control-sm" style="width: 70%;" placeholder="评分标准名称" value="新评分标准">
                    <button class="btn btn-sm btn-outline-danger" onclick="removeCriteria(this)"><i class="fas fa-trash"></i></button>
                </div>
                <textarea class="form-control" rows="3" placeholder="描述如何评估这个标准..."></textarea>
            `;
            container.appendChild(criteriaItem);
        }

        // 删除评分标准
        function removeCriteria(button) {
            const criteriaItem = button.closest('.criteria-item');
            const criterionId = criteriaItem.getAttribute('data-criterion-id');
            
            if (document.querySelectorAll('.criteria-item').length > 1) {
                criteriaItem.remove();
                
                // 如果是预设标准，从已添加集合中移除
                if (criterionId) {
                    addedCriteriaIds.delete(criterionId);
                    // 更新菜单，该标准可以再次添加
                    updatePresetCriteriaMenu();
                    console.log('✅ 已移除评分标准:', criterionId);
                }
            } else {
                alert('至少需要保留一个评分标准');
            }
        }

        // 运行测试
        async function runTest() {
            // 收集配置数据
            const children = [];
            document.querySelectorAll('.child-card').forEach(card => {
                const inputs = card.querySelectorAll('input, textarea');
                children.push({
                    name: inputs[0].value,
                    age: parseInt(inputs[1].value),
                    traits: inputs[2].value,
                    opening: inputs[3].value
                });
            });

            // 收集动态评分标准
            const criteria = {};
            document.querySelectorAll('.criteria-item').forEach((item, index) => {
                const nameInput = item.querySelector('input[type="text"]');
                const textarea = item.querySelector('textarea');
                const criteriaName = nameInput.value.trim() || `评分标准${index + 1}`;
                criteria[criteriaName] = textarea.value;
            });

            // 显示实时进度
            showRealTimeProgress(children);

            // 依次测试每个角色
            for (let i = 0; i < children.length; i++) {
                await runRealTimeTest(children[i], criteria, i);
            }
        }

        // 实时对话测试
        async function runRealTimeTest(child, criteria, childIndex) {
            const container = document.getElementById('results-container');
            const allCards = container.querySelectorAll('.result-card');
            const currentCard = allCards[childIndex];
            const conversationContainer = currentCard.querySelector('.conversation-container');
            const progressText = currentCard.querySelector('.progress-text');
            
            let conversationId = null;
            let currentMessage = child.opening;
            const conversationLog = [];
            
            // 不再使用预设的回应，而是使用Gemini生成
            
            // 获取用户设置的轮数
            const maxRounds = getRounds();
            
            // 进行对话测试
            for (let round = 1; round <= maxRounds; round++) {
                // 显示当前轮次的进度
                if (progressText) {
                    progressText.innerHTML = `<i class="fas fa-spinner fa-spin"></i> 正在进行第${round}轮对话... (${round}/${maxRounds})`;
                }
                
                try {
                    // 获取API密钥
                    const apiKeys = getApiKeys();
                    
                    // 调用单轮对话API
                    const response = await fetch('/api/test-round', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            child: child,
                            criteria: criteria,
                            round_num: round,
                            conversation_id: conversationId,
                            message: currentMessage,
                            conversation_history: conversationLog,
                            ...apiKeys
                        })
                    });
                    
                    // 先检查HTTP状态码
                    if (!response.ok) {
                        // HTTP错误（包括500）
                        const errorResult = await response.json();
                        console.error('第' + round + '轮HTTP错误:', errorResult);
                        alert('❌ 测试失败！\n\n' + (errorResult.message || '第' + round + '轮对话失败') + '\n\n错误详情: ' + (errorResult.error || 'HTTP ' + response.status));
                        
                        // 隐藏加载状态
                        document.querySelector('.loading').style.display = 'none';
                        return; // 停止测试
                    }
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        // 更新对话ID
                        conversationId = result.conversation_id;
                        
                        // 🔥 额外验证：确保ai_response不为空且不是错误消息
                        if (!result.ai_response || result.ai_response.trim() === '' || 
                            result.ai_response.includes('连接失败') || 
                            result.ai_response.includes('API失败')) {
                            console.error('第' + round + '轮检测到无效的AI回复:', result.ai_response);
                            alert('❌ 测试失败！\n\n第' + round + '轮：AI回复无效或为空\n\n请检查Dify配置');
                            document.querySelector('.loading').style.display = 'none';
                            return; // 停止测试
                        }
                        
                        // 记录对话
                        const conversation = {
                            round: result.round,
                            user_message: result.user_message,
                            ai_response: result.ai_response,
                            timestamp: result.timestamp
                        };
                        conversationLog.push(conversation);
                        
                        // 实时显示这一轮对话
                        displaySingleRound(conversationContainer, conversation);
                        
                        // 准备下一轮消息（使用Gemini生成孩子回应）
                        if (round < maxRounds) {
                            try {
                                const childResponse = await fetch('/api/generate-child-response', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json'
                                    },
                                    body: JSON.stringify({
                                        child: child,
                                        ai_response: result.ai_response,
                                        round_num: round + 1,
                                        conversation_history: conversationLog,
                                        ...apiKeys
                                    })
                                });
                                
                                const childResult = await childResponse.json();
                                if (childResult.success) {
                                    currentMessage = childResult.child_response;
                                } else {
                                    currentMessage = "我想了解更多！";
                                }
                            } catch (error) {
                                console.error('生成孩子回应失败:', error);
                                currentMessage = "我想了解更多！";
                            }
                        }
                        
                        // 添加延迟，让用户能看到实时效果
                        await new Promise(resolve => setTimeout(resolve, 1000));
                    } else {
                        // Dify API失败，弹出错误并停止测试
                        console.error('第' + round + '轮对话失败:', result.message);
                        alert('❌ 测试失败！\n\n' + result.message + '\n\n错误详情: ' + (result.error || '未知错误'));
                        
                        // 隐藏加载状态
                        document.querySelector('.loading').style.display = 'none';
                        return; // 停止测试
                    }
                } catch (error) {
                    console.error('第' + round + '轮对话出错:', error);
                    alert('❌ 网络错误！\n\n第' + round + '轮对话请求失败\n\n错误详情: ' + error.message);
                    
                    // 隐藏加载状态
                    document.querySelector('.loading').style.display = 'none';
                    return; // 停止测试
                }
            }
            
            // 所有对话完成后，进行评分
            await performFinalEvaluation(child, criteria, conversationLog, conversationContainer, progressText);
        }

        // 显示单轮对话
        function displaySingleRound(container, conversation) {
            const roundHtml = `
                <div class="conversation-round mb-3 p-3 rounded" style="background-color: white; border-left: 4px solid #007bff;">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <strong>第${conversation.round}轮</strong>
                        <small class="text-muted">${conversation.timestamp}</small>
                    </div>
                    <div class="mb-2">
                        <strong>孩子：</strong><span class="text-primary">${conversation.user_message}</span>
                    </div>
                    <div>
                        <strong>AI：</strong><span class="text-success">${conversation.ai_response}</span>
                    </div>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', roundHtml);
            
            // 滚动到最新内容
            container.scrollTop = container.scrollHeight;
        }

        // 执行最终评分
        async function performFinalEvaluation(child, criteria, conversationLog, conversationContainer, progressText) {
            // 显示评分中状态
            if (progressText) {
                progressText.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 正在进行最终评分...';
            }
            
            try {
                // 获取API密钥
                const apiKeys = getApiKeys();
                
                // 调用后端评分API
                const response = await fetch('/api/evaluate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        child: child,
                        conversation_history: conversationLog,
                        criteria: criteria,
                        ...apiKeys
                    })
                });
                
                const evalResult = await response.json();
                
                const result = {
                    child: child.name,
                    age: child.age,
                    traits: child.traits,
                    opening: child.opening,
                    conversation_log: conversationLog,
                    scores: evalResult.scores || {},
                    score_details: evalResult.score_details || {},
                    reason: evalResult.reason || "评分完成",
                    lessons: evalResult.lessons || "暂无经验教训",
                    character_review: evalResult.character_review || "",
                    timestamp: new Date().toLocaleString()
                };
                
                // 显示最终结果
                displayFinalResults(conversationContainer, result, progressText);
                
                // 保存到CSV
                await saveResultToCSV(child, criteria, conversationLog, evalResult.scores, evalResult.reason, evalResult.lessons, evalResult.character_review);
                
            } catch (error) {
                console.error('评分过程出错:', error);
                // 如果评分失败，仍然显示对话记录
                const result = {
                    child: child.name,
                    age: child.age,
                    traits: child.traits,
                    opening: child.opening,
                    conversation_log: conversationLog,
                    scores: {},
                    score_details: {},
                    reason: "评分过程出错：" + error.message,
                    lessons: "评分失败，无法生成经验教训",
                    character_review: "",
                    timestamp: new Date().toLocaleString()
                };
                displayFinalResults(conversationContainer, result, progressText);
                
                // 即使评分失败，也保存对话记录到CSV
                await saveResultToCSV(child, criteria, conversationLog, {}, "评分过程出错：" + error.message, "", "");
            }
        }

        // 显示最终结果
        function displayFinalResults(container, result, progressText) {
            const scores = result.scores || {};
            const scoreDetails = result.score_details || {};
            const scoreKeys = Object.keys(scores);
            
            // 生成每个评分标准的详细卡片
            const scoreDetailsHtml = scoreKeys.map((key, i) => {
                const score = scores[key] || 0;
                let detail = scoreDetails[key] || '暂无详细理由';
                // 确保detail是字符串
                if (typeof detail !== 'string') {
                    detail = String(detail) || '暂无详细理由';
                }
                const colors = ['primary', 'success', 'warning', 'info', 'danger', 'secondary', 'dark'];
                const color = colors[i % colors.length];
                
                // 根据分数选择图标
                let icon = 'fa-star';
                if (score >= 9) icon = 'fa-star text-warning';
                else if (score >= 7) icon = 'fa-check-circle text-success';
                else if (score >= 5) icon = 'fa-minus-circle text-primary';
                else icon = 'fa-times-circle text-danger';
                
                return `
                    <div class="card mb-2">
                        <div class="card-header bg-${color} text-white d-flex justify-content-between align-items-center">
                            <span><i class="fas ${icon}"></i> ${key}</span>
                            <span class="badge bg-light text-dark">${score} 分</span>
                        </div>
                        <div class="card-body">
                            <small style="white-space: pre-wrap;">${detail}</small>
                        </div>
                    </div>
                `;
            }).join('');
            
            // 格式化经验教训（保留换行和列表格式）
            // 确保lessons是字符串类型
            let lessonsText = result.lessons || '无';
            if (typeof lessonsText !== 'string') {
                lessonsText = JSON.stringify(lessonsText) || '无';
            }
            const lessonsFormatted = lessonsText.replace(/\n/g, '<br>');
            
            // 确保reason也是字符串
            let reasonText = result.reason || '无';
            if (typeof reasonText !== 'string') {
                reasonText = String(reasonText) || '无';
            }
            
            // 确保character_review也是字符串
            let characterReviewText = result.character_review || '';
            if (typeof characterReviewText !== 'string') {
                characterReviewText = String(characterReviewText) || '';
            }
            const characterReviewFormatted = characterReviewText.replace(/\n/g, '<br>');
            
            // 只有当有角色自述时才显示角色自述卡片
            const characterReviewHtml = characterReviewText ? `
                <div class="card border-success mb-2">
                    <div class="card-header bg-success text-white">
                        <i class="fas fa-child"></i> 角色自述（${result.child}的感受）
                    </div>
                    <div class="card-body" style="background-color: #f0f8ff;">
                        <small style="white-space: pre-wrap; font-style: italic;">"${characterReviewFormatted}"</small>
                    </div>
                </div>
            ` : '';
            
            const finalHtml = `
                <div class="mt-4">
                    <h6 class="mb-3"><i class="fas fa-star"></i> 📊 详细评分结果</h6>
                    ${scoreDetailsHtml}
                    
                    <div class="card mb-2 border-info">
                        <div class="card-header bg-info text-white">
                            <i class="fas fa-lightbulb"></i> 总体评价
                        </div>
                        <div class="card-body">
                            <small style="white-space: pre-wrap;">${reasonText}</small>
                        </div>
                    </div>
                    
                    <div class="card border-warning mb-2">
                        <div class="card-header bg-warning text-dark">
                            <i class="fas fa-book"></i> 经验教训
                        </div>
                        <div class="card-body">
                            <small style="white-space: pre-wrap;">${lessonsFormatted}</small>
                        </div>
                    </div>
                    
                    ${characterReviewHtml}
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', finalHtml);
            
            // 更新进度文本
            if (progressText) {
                progressText.innerHTML = '<i class="fas fa-check-circle"></i> 测试完成！';
            }
        }

        // 保存结果到CSV
        async function saveResultToCSV(child, criteria, conversationLog, scores, reason, lessons, character_review) {
            try {
                const response = await fetch('/api/save-result', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        child: child,
                        criteria: criteria,
                        conversations: conversationLog,
                        scores: scores || {},
                        reason: reason || '',
                        lessons: lessons || '',
                        character_review: character_review || '',
                        timestamp: new Date().toLocaleString('zh-CN', {
                            year: 'numeric',
                            month: '2-digit',
                            day: '2-digit',
                            hour: '2-digit',
                            minute: '2-digit',
                            second: '2-digit'
                        })
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    console.log('✅ 测试结果已保存到CSV');
                } else {
                    console.error('❌ 保存CSV失败:', result.message);
                }
            } catch (error) {
                console.error('❌ 保存CSV出错:', error);
            }
        }

        // 显示实时进度
        function showRealTimeProgress(children) {
            const container = document.getElementById('results-container');
            const maxRounds = getRounds();
            let html = '<div class="row">';
            
            children.forEach((child, index) => {
                html += `
                    <div class="col-md-12 mb-4">
                        <div class="card result-card">
                            <div class="card-header">
                                <h5><i class="fas fa-child"></i> ${child.name} (${child.age}岁) - ${maxRounds}轮对话</h5>
                            </div>
                            <div class="card-body">
                                <p><strong>性格特点：</strong>${child.traits}</p>
                                <p><strong>开场白：</strong>${child.opening}</p>
                                <hr>
                                <h6><i class="fas fa-comments"></i> 对话记录：</h6>
                                <div class="progress-text text-center text-primary mb-3">
                                    <i class="fas fa-spinner fa-spin"></i> 准备开始对话测试...
                                </div>
                                <div class="conversation-container" style="max-height: 400px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 5px; padding: 15px; background-color: #f8f9fa;">
                                    <div class="text-center text-muted">
                                        <p>等待对话开始...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }

        // 存储当前结果
        let currentResults = [];

        // 显示结果
        function displayResults(results) {
            currentResults = results; // 保存结果
            const container = document.getElementById('results-container');
            const maxRounds = getRounds();
            let html = '<div class="row">';
            
            results.forEach((result, index) => {
                const scores = result.scores || {};
                const scoreKeys = Object.keys(scores);
                const conversationLog = result.conversation_log || [];
                
                html += `
                    <div class="col-md-12 mb-4">
                        <div class="card result-card">
                            <div class="card-header">
                                <h5><i class="fas fa-child"></i> ${result.child} (${result.age}岁) - ${maxRounds}轮对话</h5>
                            </div>
                            <div class="card-body">
                                <p><strong>性格特点：</strong>${result.traits}</p>
                                <p><strong>开场白：</strong>${result.opening}</p>
                                <hr>
                                <h6><i class="fas fa-comments"></i> 对话记录：</h6>
                                <div class="conversation-container" style="max-height: 400px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 5px; padding: 15px; background-color: #f8f9fa;">
                `;
                
                // 显示每轮对话
                conversationLog.forEach((conversation, roundIndex) => {
                    html += `
                        <div class="conversation-round mb-3 p-3 rounded" style="background-color: white; border-left: 4px solid #007bff;">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <strong>第${conversation.round}轮</strong>
                                <small class="text-muted">${conversation.timestamp}</small>
                            </div>
                            <div class="mb-2">
                                <strong>孩子：</strong><span class="text-primary">${conversation.user_message}</span>
                            </div>
                            <div>
                                <strong>AI：</strong><span class="text-success">${conversation.ai_response}</span>
                            </div>
                        </div>
                    `;
                });
                
                html += `
                                </div>
                                <hr>
                                <div class="row text-center">
                `;
                
                // 动态显示评分
                scoreKeys.forEach((key, i) => {
                    const colors = ['bg-primary', 'bg-success', 'bg-warning', 'bg-info', 'bg-danger', 'bg-secondary'];
                    const color = colors[i % colors.length];
                    html += `
                        <div class="col-${Math.floor(12 / scoreKeys.length)}">
                            <span class="badge ${color} score-badge">${key}: ${scores[key] || 0}</span>
                        </div>
                    `;
                });
                
                html += `
                                </div>
                                <p class="mt-2"><small class="text-muted">${result.reason}</small></p>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }

        // 清空结果
        function clearResults() {
            if (confirm('确定要清空所有结果吗？')) {
                currentResults = [];
                document.getElementById('results-container').innerHTML = `
                    <div class="text-center text-muted">
                        <i class="fas fa-clipboard-list fa-3x mb-3"></i>
                        <p>配置测试角色和评分标准，然后点击"开始测试"</p>
                    </div>
                `;
            }
        }
    </script>
</body>
</html>
