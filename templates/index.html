<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å„¿ç«¥AIå¯¹è¯æµ‹è¯•å¹³å°</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .card {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border: none;
            margin-bottom: 20px;
        }
        .card-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
        }
        .btn-primary:hover {
            background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
        }
        .result-card {
            border-left: 4px solid #28a745;
        }
        .score-badge {
            font-size: 1.2em;
            padding: 8px 16px;
        }
        .loading {
            display: none;
        }
        .child-card {
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }
        .child-card:hover {
            border-color: #667eea;
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.2);
        }
        .criteria-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 10px;
        }
        .criteria-item.border-primary {
            border: 2px solid #007bff;
            background: #f0f8ff;
        }
        .card.border-secondary {
            border-left: 3px solid #6c757d;
        }
        .card.border-secondary .card-header {
            background: #e9ecef !important;
            color: #495057 !important;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- å·¦ä¾§é…ç½®é¢æ¿ -->
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h4><i class="fas fa-cog"></i> æµ‹è¯•é…ç½®</h4>
                    </div>
                    <div class="card-body">
                        <!-- æµ‹è¯•è§’è‰²é…ç½® -->
                        <h5><i class="fas fa-child"></i> æµ‹è¯•è§’è‰²</h5>
                        <div id="children-container">
                            <!-- é»˜è®¤è§’è‰²å°†è‡ªåŠ¨åŠ è½½ -->
                                    </div>
                        <div class="d-flex gap-2 mb-3">
                        <button class="btn btn-outline-primary btn-sm" onclick="addChild()">
                                <i class="fas fa-plus"></i> æ·»åŠ è‡ªå®šä¹‰è§’è‰²
                        </button>
                            <div class="dropdown">
                                <button class="btn btn-primary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                    <i class="fas fa-user-plus"></i> å¿«é€Ÿæ·»åŠ å†…ç½®è§’è‰²
                                </button>
                                <ul class="dropdown-menu" id="preset-children-menu">
                                    <li><a class="dropdown-item text-muted" href="#">åŠ è½½ä¸­...</a></li>
                                </ul>
                            </div>
                        </div>

                        <!-- è¯„åˆ†æ ‡å‡†é…ç½® -->
                        <h5 class="mt-4"><i class="fas fa-chart-line"></i> è¯„åˆ†æ ‡å‡†</h5>
                        <div id="criteria-container">
                            <!-- é»˜è®¤è¯„åˆ†æ ‡å‡†å°†è‡ªåŠ¨åŠ è½½ -->
                                </div>
                        <div class="d-flex gap-2 mb-3">
                        <button class="btn btn-outline-primary btn-sm" onclick="addCriteria()">
                                <i class="fas fa-plus"></i> æ·»åŠ è‡ªå®šä¹‰æ ‡å‡†
                        </button>
                            <div class="dropdown">
                                <button class="btn btn-success btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                    <i class="fas fa-star"></i> å¿«é€Ÿæ·»åŠ å†…ç½®æ ‡å‡†
                                </button>
                                <ul class="dropdown-menu" id="preset-criteria-menu">
                                    <li><a class="dropdown-item text-muted" href="#">åŠ è½½ä¸­...</a></li>
                                </ul>
                            </div>
                        </div>

                        <!-- æ“ä½œæŒ‰é’® -->
                        <div class="d-grid gap-2 mt-4">
                            <button class="btn btn-primary" onclick="runTest()" id="start-test-btn">
                                <i class="fas fa-play"></i> å¼€å§‹æµ‹è¯•
                            </button>
                            <button class="btn btn-success" onclick="startAutoTest()" id="auto-test-btn">
                                <i class="fas fa-sync-alt"></i> è‡ªåŠ¨å¾ªç¯æµ‹è¯•
                            </button>
                            <button class="btn btn-danger" onclick="stopAutoTest()" id="stop-auto-btn" style="display: none;">
                                <i class="fas fa-stop"></i> æš‚åœè‡ªåŠ¨æµ‹è¯•
                            </button>
                            <a href="/dashboard" class="btn btn-info" target="_blank">
                                <i class="fas fa-chart-line"></i> æ•°æ®ä»ªè¡¨ç›˜
                            </a>
                            <button class="btn btn-warning" onclick="clearResults()">
                                <i class="fas fa-trash"></i> æ¸…ç©ºç»“æœ
                            </button>
                        </div>
                        
                        <!-- è‡ªåŠ¨æµ‹è¯•ç»Ÿè®¡ -->
                        <div id="auto-test-stats" class="mt-3" style="display: none;">
                            <div class="alert alert-info">
                                <h6 class="mb-2"><i class="fas fa-chart-line"></i> è‡ªåŠ¨æµ‹è¯•ç»Ÿè®¡</h6>
                                <div class="small">
                                    <div>å·²å®Œæˆæµ‹è¯•ï¼š<strong id="test-count">0</strong> æ¬¡</div>
                                    <div>è¿è¡Œæ—¶é—´ï¼š<strong id="test-duration">00:00:00</strong></div>
                                    <div>å½“å‰çŠ¶æ€ï¼š<strong id="test-status">è¿è¡Œä¸­</strong></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å³ä¾§ç»“æœé¢æ¿ -->
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h4 class="mb-0"><i class="fas fa-chart-bar"></i> æµ‹è¯•ç»“æœ</h4>
                        <button class="btn btn-outline-light btn-sm" data-bs-toggle="modal" data-bs-target="#settingsModal">
                            <i class="fas fa-cog"></i> è®¾ç½®
                        </button>
                    </div>
                    <div class="card-body">
                        <!-- åŠ è½½çŠ¶æ€ -->
                        <div class="loading text-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">æµ‹è¯•ä¸­...</span>
                            </div>
                            <p class="mt-2">æ­£åœ¨è¿è¡Œæµ‹è¯•ï¼Œè¯·ç¨å€™...</p>
                        </div>

                        <!-- ç»“æœå±•ç¤º -->
                        <div id="results-container">
                            <div class="text-center text-muted">
                                <i class="fas fa-clipboard-list fa-3x mb-3"></i>
                                <p>é…ç½®æµ‹è¯•è§’è‰²å’Œè¯„åˆ†æ ‡å‡†ï¼Œç„¶åç‚¹å‡»"å¼€å§‹æµ‹è¯•"</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- è®¾ç½®æ¨¡æ€å¼¹çª— -->
    <div class="modal fade" id="settingsModal" tabindex="-1" aria-labelledby="settingsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="settingsModalLabel">
                        <i class="fas fa-cog"></i> é«˜çº§è®¾ç½®
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- APIå¯†é’¥é…ç½® -->
                    <h5 class="mb-3"><i class="fas fa-key"></i> APIå¯†é’¥é…ç½®</h5>
                    <div class="card mb-4">
                        <div class="card-body">
                            <div class="mb-3">
                                <label for="dify-api-key" class="form-label">
                                    <strong>Dify API Key</strong>
                                    <small class="text-muted">(å¯é€‰ï¼Œç•™ç©ºä½¿ç”¨é»˜è®¤é…ç½®)</small>
                                </label>
                                <div class="input-group">
                                    <input type="password" class="form-control" id="dify-api-key" placeholder="ç•™ç©ºä½¿ç”¨é»˜è®¤å¯†é’¥">
                                    <button class="btn btn-outline-secondary" type="button" onclick="togglePasswordVisibility('dify-api-key')">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                                <small class="form-text text-muted">ç”¨äºè¿æ¥Dify Agent</small>
                            </div>
                            <div class="mb-0">
                                <label for="gemini-api-key" class="form-label">
                                    <strong>Gemini API Key</strong>
                                    <small class="text-muted">(å¯é€‰ï¼Œç•™ç©ºä½¿ç”¨é»˜è®¤é…ç½®)</small>
                                </label>
                                <div class="input-group">
                                    <input type="password" class="form-control" id="gemini-api-key" placeholder="ç•™ç©ºä½¿ç”¨é»˜è®¤å¯†é’¥">
                                    <button class="btn btn-outline-secondary" type="button" onclick="togglePasswordVisibility('gemini-api-key')">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                                <small class="form-text text-muted">ç”¨äºç”Ÿæˆå­©å­å›å¤å’Œè¯„åˆ†</small>
                            </div>
                        </div>
                    </div>

                    <!-- å¯¹è¯è½®æ•°è®¾ç½® -->
                    <h5 class="mb-3"><i class="fas fa-sync-alt"></i> å¯¹è¯è½®æ•°è®¾ç½®</h5>
                    <div class="card mb-3">
                        <div class="card-body">
                            <label for="rounds-input" class="form-label">
                                <strong>æ¯ä¸ªè§’è‰²æµ‹è¯•è½®æ•°</strong>
                            </label>
                            <input type="number" class="form-control" id="rounds-input" min="1" max="10" value="3">
                            <small class="form-text text-muted">å»ºè®®1-10è½®ï¼Œé»˜è®¤3è½®ã€‚è½®æ•°è¶Šå¤šï¼Œå¯¹è¯è¶Šæ·±å…¥ï¼Œä½†æµ‹è¯•æ—¶é—´ä¹Ÿè¶Šé•¿ã€‚</small>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> å…³é—­
                    </button>
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">
                        <i class="fas fa-check"></i> ä¿å­˜è®¾ç½®
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // ========== è‡ªåŠ¨æµ‹è¯•å…¨å±€å˜é‡ ==========
        let isAutoTestRunning = false;  // æ˜¯å¦æ­£åœ¨è‡ªåŠ¨æµ‹è¯•
        let autoTestCount = 0;           // å·²å®Œæˆçš„æµ‹è¯•æ¬¡æ•°
        let autoTestStartTime = null;    // è‡ªåŠ¨æµ‹è¯•å¼€å§‹æ—¶é—´
        let autoTestTimer = null;        // è®¡æ—¶å™¨
        
        // åˆ‡æ¢å¯†ç å¯è§æ€§
        function togglePasswordVisibility(inputId) {
            const input = document.getElementById(inputId);
            const button = input.nextElementSibling;
            const icon = button.querySelector('i');
            
            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                input.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        }
        
        // è·å–ç”¨æˆ·è®¾ç½®çš„APIå¯†é’¥
        function getApiKeys() {
            const difyKey = document.getElementById('dify-api-key').value.trim();
            const geminiKey = document.getElementById('gemini-api-key').value.trim();
            
            return {
                dify_api_key: difyKey || null,  // å¦‚æœä¸ºç©ºï¼Œåç«¯ä½¿ç”¨é»˜è®¤å€¼
                gemini_api_key: geminiKey || null
            };
        }
        
        // è·å–ç”¨æˆ·è®¾ç½®çš„å¯¹è¯è½®æ•°
        function getRounds() {
            return parseInt(document.getElementById('rounds-input').value) || 3;
        }
        
        // å†…ç½®è§’è‰²æ•°æ®ï¼ˆä»APIåŠ è½½ï¼‰
        let presetChildren = {};
        // å·²æ·»åŠ çš„è§’è‰²IDé›†åˆ
        let addedChildrenIds = new Set();

        // ä»APIåŠ è½½å†…ç½®è§’è‰²æ•°æ®
        async function loadPresetChildren() {
            try {
                const response = await fetch('/api/preset-children');
                if (response.ok) {
                    presetChildren = await response.json();
                    updatePresetChildrenMenu();
                    console.log('âœ… å†…ç½®è§’è‰²åŠ è½½æˆåŠŸ:', Object.keys(presetChildren).length, 'ä¸ªè§’è‰²');
                    
                    // è‡ªåŠ¨æ·»åŠ ç¬¬ä¸€ä¸ªé¢„è®¾è§’è‰²ä½œä¸ºé»˜è®¤è§’è‰²
                    const firstPresetId = Object.keys(presetChildren)[0];
                    if (firstPresetId) {
                        addPresetChild(firstPresetId);
                        addedChildrenIds.add(firstPresetId);
                        console.log('âœ… å·²è‡ªåŠ¨æ·»åŠ é»˜è®¤è§’è‰²:', presetChildren[firstPresetId].name);
                        // æ›´æ–°èœå•ä»¥æ’é™¤å·²æ·»åŠ çš„è§’è‰²
                        updatePresetChildrenMenu();
                    }
                } else {
                    console.error('âŒ åŠ è½½å†…ç½®è§’è‰²å¤±è´¥:', response.status);
                }
            } catch (error) {
                console.error('âŒ åŠ è½½å†…ç½®è§’è‰²å¼‚å¸¸:', error);
            }
        }

        // æ›´æ–°å†…ç½®è§’è‰²ä¸‹æ‹‰èœå•
        function updatePresetChildrenMenu() {
            const menu = document.getElementById('preset-children-menu');
            if (!menu) return;
            
            menu.innerHTML = '';
            
            // è¿‡æ»¤æ‰å·²æ·»åŠ çš„è§’è‰²
            const availableChildren = Object.entries(presetChildren).filter(([id, child]) => !addedChildrenIds.has(id));
            
            if (availableChildren.length === 0) {
                menu.innerHTML = '<li><a class="dropdown-item text-muted" href="#">æ‰€æœ‰è§’è‰²å·²æ·»åŠ </a></li>';
                return;
            }
            
            // åŠ¨æ€ç”Ÿæˆèœå•é¡¹ï¼ˆåªæ˜¾ç¤ºæœªæ·»åŠ çš„è§’è‰²ï¼‰
            for (const [id, child] of availableChildren) {
                const menuItem = document.createElement('li');
                menuItem.innerHTML = `
                    <a class="dropdown-item" href="#" onclick="addPresetChild('${id}'); return false;">
                        ${child.emoji || 'ğŸ§’'} ${child.name} - ${child.type || 'æµ‹è¯•å‹'}
                    </a>
                `;
                menu.appendChild(menuItem);
            }
        }

        // å†…ç½®è¯„åˆ†æ ‡å‡†æ•°æ®ï¼ˆä»APIåŠ è½½ï¼‰
        let presetCriteria = {};
        // å·²æ·»åŠ çš„è¯„åˆ†æ ‡å‡†IDé›†åˆ
        let addedCriteriaIds = new Set();

        // ä»APIåŠ è½½å†…ç½®è¯„åˆ†æ ‡å‡†æ•°æ®
        async function loadPresetCriteria() {
            try {
                const response = await fetch('/api/preset-criteria');
                if (response.ok) {
                    presetCriteria = await response.json();
                    updatePresetCriteriaMenu();
                    console.log('âœ… å†…ç½®è¯„åˆ†æ ‡å‡†åŠ è½½æˆåŠŸ:', Object.keys(presetCriteria).length, 'ä¸ªæ ‡å‡†');
                    
                    // åªè‡ªåŠ¨æ·»åŠ ç¬¬ä¸€ä¸ªé¢„è®¾è¯„åˆ†æ ‡å‡†çš„ç¬¬ä¸€ä¸ªäºŒçº§æŒ‡æ ‡ä½œä¸ºé»˜è®¤æ ‡å‡†
                    const criteriaIds = Object.keys(presetCriteria);
                    if (criteriaIds.length > 0) {
                        const firstMainCriteria = presetCriteria[criteriaIds[0]];
                        if (firstMainCriteria.sub_criteria) {
                            const subCriteriaIds = Object.keys(firstMainCriteria.sub_criteria);
                            if (subCriteriaIds.length > 0) {
                                // æ·»åŠ ç¬¬ä¸€ä¸ªäºŒçº§æŒ‡æ ‡
                                addSubCriterion(criteriaIds[0], subCriteriaIds[0]);
                                console.log(`âœ… å·²è‡ªåŠ¨æ·»åŠ é»˜è®¤è¯„åˆ†æ ‡å‡†: ${firstMainCriteria.sub_criteria[subCriteriaIds[0]].name}`);
                            }
                        }
                    }
                    // æ›´æ–°èœå•ä»¥æ’é™¤å·²æ·»åŠ çš„æ ‡å‡†
                    updatePresetCriteriaMenu();
                } else {
                    console.error('âŒ åŠ è½½å†…ç½®è¯„åˆ†æ ‡å‡†å¤±è´¥:', response.status);
                }
            } catch (error) {
                console.error('âŒ åŠ è½½å†…ç½®è¯„åˆ†æ ‡å‡†å¼‚å¸¸:', error);
            }
        }

        // æ›´æ–°å†…ç½®è¯„åˆ†æ ‡å‡†ä¸‹æ‹‰èœå•
        function updatePresetCriteriaMenu() {
            const menu = document.getElementById('preset-criteria-menu');
            if (!menu) return;
            
            menu.innerHTML = '';
            
            // è¿‡æ»¤æ‰å·²æ·»åŠ çš„ä¸€çº§æŒ‡æ ‡ï¼ˆæ£€æŸ¥æ˜¯å¦æ•´ä¸ªä¸€çº§æŒ‡æ ‡éƒ½è¢«æ·»åŠ äº†ï¼‰
            const availableCriteria = Object.entries(presetCriteria).filter(([id, criterion]) => {
                // æ£€æŸ¥æ˜¯å¦æ•´ä¸ªä¸€çº§æŒ‡æ ‡éƒ½è¢«æ·»åŠ äº†
                const hasAllSubCriteria = criterion.sub_criteria && Object.keys(criterion.sub_criteria).every(subId => 
                    addedCriteriaIds.has(`${id}.${subId}`)
                );
                return !addedCriteriaIds.has(id) && !hasAllSubCriteria;
            });
            
            if (availableCriteria.length === 0) {
                menu.innerHTML = '<li><a class="dropdown-item text-muted" href="#">æ‰€æœ‰æ ‡å‡†å·²æ·»åŠ </a></li>';
                return;
            }
            
            // åŠ¨æ€ç”Ÿæˆèœå•é¡¹ï¼ˆåªæ˜¾ç¤ºæœªæ·»åŠ çš„ä¸€çº§æŒ‡æ ‡ï¼‰
            for (const [id, criterion] of availableCriteria) {
                const menuItem = document.createElement('li');
                menuItem.innerHTML = `
                    <a class="dropdown-item" href="#" onclick="showSubCriteria('${id}'); return false;">
                        <i class="fas fa-chevron-right"></i> ${criterion.name}
                    </a>
                `;
                menu.appendChild(menuItem);
            }
        }

        // æ˜¾ç¤ºå­æŒ‡æ ‡é€‰æ‹©å¼¹çª—
        function showSubCriteria(criterionId) {
            const criterion = presetCriteria[criterionId];
            if (!criterion || !criterion.sub_criteria) return;
            
            // åˆ›å»ºæ¨¡æ€å¼¹çª—
            const modalHtml = `
                <div class="modal fade" id="subCriteriaModal" tabindex="-1" aria-labelledby="subCriteriaModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header bg-primary text-white">
                                <h5 class="modal-title" id="subCriteriaModalLabel">
                                    <i class="fas fa-list"></i> é€‰æ‹© ${criterion.name} çš„å­æŒ‡æ ‡
                                </h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <p class="text-muted mb-3">${criterion.description}</p>
                                <div class="row">
                                    ${Object.entries(criterion.sub_criteria).map(([subId, subCriterion]) => {
                                        const subCriterionId = `${criterionId}.${subId}`;
                                        const isAdded = addedCriteriaIds.has(subCriterionId);
                                        return `
                                        <div class="col-md-6 mb-3">
                                            <div class="card border-secondary ${isAdded ? 'opacity-50' : ''}">
                                                <div class="card-header bg-light">
                                                    <h6 class="mb-0">${subCriterion.name} ${isAdded ? '<span class="badge bg-success">å·²æ·»åŠ </span>' : ''}</h6>
                                                </div>
                                                <div class="card-body">
                                                    <p class="small text-muted mb-2">${subCriterion.description}</p>
                                                    ${isAdded ? 
                                                        '<button class="btn btn-sm btn-outline-secondary" disabled><i class="fas fa-check"></i> å·²æ·»åŠ </button>' :
                                                        `<button class="btn btn-sm btn-outline-primary" onclick="addSubCriterion('${criterionId}', '${subId}'); return false;"><i class="fas fa-plus"></i> æ·»åŠ æ­¤æŒ‡æ ‡</button>`
                                                    }
                                                </div>
                                            </div>
                                        </div>
                                    `}).join('')}
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                    <i class="fas fa-times"></i> å…³é—­
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // ç§»é™¤å·²å­˜åœ¨çš„æ¨¡æ€å¼¹çª—
            const existingModal = document.getElementById('subCriteriaModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // æ·»åŠ æ–°çš„æ¨¡æ€å¼¹çª—
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // æ˜¾ç¤ºæ¨¡æ€å¼¹çª—
            const modal = new bootstrap.Modal(document.getElementById('subCriteriaModal'));
            modal.show();
        }
        
        // æ·»åŠ å­æŒ‡æ ‡
        function addSubCriterion(criterionId, subId) {
            const criterion = presetCriteria[criterionId];
            if (!criterion || !criterion.sub_criteria || !criterion.sub_criteria[subId]) return;
            
            // æ£€æŸ¥æ˜¯å¦å·²ç»æ·»åŠ è¿‡è¿™ä¸ªå­æŒ‡æ ‡
            const subCriterionId = `${criterionId}.${subId}`;
            if (addedCriteriaIds.has(subCriterionId)) {
                alert('è¯¥è¯„åˆ†æ ‡å‡†å·²ç»æ·»åŠ è¿‡äº†ï¼');
                return;
            }
            
            const subCriterion = criterion.sub_criteria[subId];
            const container = document.getElementById('criteria-container');
            
            // åˆ›å»ºå­æŒ‡æ ‡é¡¹
            const criteriaItem = document.createElement('div');
            criteriaItem.className = 'criteria-item';
            criteriaItem.setAttribute('data-criterion-id', subCriterionId);
            criteriaItem.innerHTML = `
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <input type="text" class="form-control form-control-sm" style="width: 70%;" placeholder="è¯„åˆ†æ ‡å‡†åç§°" value="${subCriterion.name}">
                    <button class="btn btn-sm btn-outline-danger" onclick="removeCriteria(this)"><i class="fas fa-trash"></i></button>
                </div>
                <textarea class="form-control form-control-sm" rows="3" placeholder="æè¿°å¦‚ä½•è¯„ä¼°è¿™ä¸ªæ ‡å‡†..." style="font-size: 0.85rem;">${subCriterion.prompt}</textarea>
            `;
            container.appendChild(criteriaItem);
            
            // è®°å½•å·²æ·»åŠ çš„æ ‡å‡†ID
            addedCriteriaIds.add(subCriterionId);
            
            // å…³é—­æ¨¡æ€å¼¹çª—
            const modal = bootstrap.Modal.getInstance(document.getElementById('subCriteriaModal'));
            if (modal) {
                modal.hide();
            }
            
            // æ›´æ–°èœå•
            updatePresetCriteriaMenu();
        }
        
        // æ·»åŠ é¢„è®¾è¯„åˆ†æ ‡å‡†ï¼ˆæ•´ä¸ªä¸€çº§æŒ‡æ ‡ï¼‰
        function addPresetCriterion(criterionId) {
            const criterion = presetCriteria[criterionId];
            if (!criterion) return;
            
            // é˜²æ­¢é‡å¤æ·»åŠ 
            if (addedCriteriaIds.has(criterionId)) {
                console.log('âš ï¸ è¯„åˆ†æ ‡å‡†å·²å­˜åœ¨ï¼Œä¸é‡å¤æ·»åŠ :', criterion.name);
                return;
            }
            
            const container = document.getElementById('criteria-container');
            
            // æ£€æŸ¥æ˜¯å¦æ˜¯ä¸€çº§æŒ‡æ ‡ï¼ˆæœ‰sub_criteriaï¼‰
            if (criterion.sub_criteria && Object.keys(criterion.sub_criteria).length > 0) {
                // ä¸€çº§æŒ‡æ ‡ï¼šæ˜¾ç¤ºä¸»æŒ‡æ ‡å’Œæ‰€æœ‰å­æŒ‡æ ‡
                const mainItem = document.createElement('div');
                mainItem.className = 'criteria-item border-primary';
                mainItem.setAttribute('data-criterion-id', criterionId);
                mainItem.innerHTML = `
                    <div class="card">
                        <div class="card-header bg-primary text-white">
                            <h6 class="mb-0"><i class="fas fa-star"></i> ${criterion.name}</h6>
                            <small>${criterion.description}</small>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                ${Object.entries(criterion.sub_criteria).map(([subId, subCriterion]) => `
                                    <div class="col-md-6 mb-3">
                                        <div class="card border-secondary">
                                            <div class="card-header bg-light">
                                                <h6 class="mb-0">${subCriterion.name}</h6>
                                            </div>
                                            <div class="card-body">
                                                <textarea class="form-control form-control-sm" rows="3" placeholder="æè¿°å¦‚ä½•è¯„ä¼°è¿™ä¸ªæ ‡å‡†..." style="font-size: 0.85rem;">${subCriterion.prompt}</textarea>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                            <div class="text-end">
                                <button class="btn btn-sm btn-outline-danger" onclick="removeCriteria(this)"><i class="fas fa-trash"></i> åˆ é™¤æ•´ä¸ªæŒ‡æ ‡ç»„</button>
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(mainItem);
            } else {
                // äºŒçº§æŒ‡æ ‡æˆ–æ—§æ ¼å¼ï¼šæ˜¾ç¤ºå•ä¸ªæŒ‡æ ‡
                const criteriaItem = document.createElement('div');
                criteriaItem.className = 'criteria-item';
                criteriaItem.setAttribute('data-criterion-id', criterionId);
                criteriaItem.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <input type="text" class="form-control form-control-sm" style="width: 70%;" placeholder="è¯„åˆ†æ ‡å‡†åç§°" value="${criterion.name}">
                        <button class="btn btn-sm btn-outline-danger" onclick="removeCriteria(this)"><i class="fas fa-trash"></i></button>
                    </div>
                    <textarea class="form-control" rows="5" placeholder="æè¿°å¦‚ä½•è¯„ä¼°è¿™ä¸ªæ ‡å‡†...">${criterion.prompt || ''}</textarea>
                `;
                container.appendChild(criteriaItem);
            }
            
            // è®°å½•å·²æ·»åŠ çš„æ ‡å‡†ID
            addedCriteriaIds.add(criterionId);
            // æ›´æ–°èœå•ï¼Œæ’é™¤å·²æ·»åŠ çš„æ ‡å‡†
            updatePresetCriteriaMenu();
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨åŠ è½½å†…ç½®è§’è‰²å’Œè¯„åˆ†æ ‡å‡†
        document.addEventListener('DOMContentLoaded', function() {
            loadPresetChildren();
            loadPresetCriteria();
        });

        // æ·»åŠ é¢„è®¾è§’è‰²
        function addPresetChild(presetId) {
            const preset = presetChildren[presetId];
            if (!preset) return;
            
            // é˜²æ­¢é‡å¤æ·»åŠ 
            if (addedChildrenIds.has(presetId)) {
                console.log('âš ï¸ è§’è‰²å·²å­˜åœ¨ï¼Œä¸é‡å¤æ·»åŠ :', preset.name);
                return;
            }
            
            const container = document.getElementById('children-container');
            const childCard = document.createElement('div');
            childCard.className = 'child-card';
            childCard.setAttribute('data-preset-id', presetId); // ä¿å­˜IDç”¨äºåˆ é™¤æ—¶è¯†åˆ«
            childCard.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <input type="text" class="form-control form-control-sm mb-2" placeholder="å§“å" value="${preset.name}" style="font-size: 0.85rem;">
                    </div>
                    <div class="col-md-6">
                        <input type="number" class="form-control form-control-sm mb-2" placeholder="å¹´é¾„" value="${preset.age}" style="font-size: 0.85rem;">
                    </div>
                </div>
                <textarea class="form-control form-control-sm mb-2" placeholder="æ€§æ ¼ç‰¹ç‚¹" rows="4" style="font-size: 0.85rem;">${preset.traits}</textarea>
                <textarea class="form-control form-control-sm mb-2" placeholder="å¼€åœºç™½" rows="2" style="font-size: 0.85rem;">${preset.opening}</textarea>
                <button class="btn btn-sm btn-danger" onclick="removeChildCard(this)"><i class="fas fa-trash"></i> åˆ é™¤</button>
            `;
            container.appendChild(childCard);
            
            // è®°å½•å·²æ·»åŠ çš„è§’è‰²ID
            addedChildrenIds.add(presetId);
            // æ›´æ–°èœå•ï¼Œæ’é™¤å·²æ·»åŠ çš„è§’è‰²
            updatePresetChildrenMenu();
        }
        
        // æ·»åŠ è‡ªå®šä¹‰æµ‹è¯•è§’è‰²
        function addChild() {
            const container = document.getElementById('children-container');
            const childCard = document.createElement('div');
            childCard.className = 'child-card';
            childCard.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <input type="text" class="form-control form-control-sm mb-2" placeholder="å§“å" value="æ–°è§’è‰²" style="font-size: 0.85rem;">
                    </div>
                    <div class="col-md-6">
                        <input type="number" class="form-control form-control-sm mb-2" placeholder="å¹´é¾„" value="8" style="font-size: 0.85rem;">
                    </div>
                </div>
                <textarea class="form-control form-control-sm mb-2" placeholder="æ€§æ ¼ç‰¹ç‚¹" rows="4" style="font-size: 0.85rem;">æ´»æ³¼å¥½åŠ¨ï¼Œå–œæ¬¢è¿åŠ¨å’Œæ¸¸æˆã€‚</textarea>
                <textarea class="form-control form-control-sm mb-2" placeholder="å¼€åœºç™½" rows="2" style="font-size: 0.85rem;">ä½ å¥½ï¼æˆ‘ä»¬æ¥ç©ä¸ªæ¸¸æˆå§ï¼</textarea>
                <button class="btn btn-sm btn-danger" onclick="removeChildCard(this)"><i class="fas fa-trash"></i> åˆ é™¤</button>
            `;
            container.appendChild(childCard);
        }

        // åˆ é™¤æµ‹è¯•è§’è‰²
        function removeChildCard(button) {
            const childCard = button.closest('.child-card');
            const presetId = childCard.getAttribute('data-preset-id');
            
            if (document.querySelectorAll('.child-card').length > 1) {
                childCard.remove();
                
                // å¦‚æœæ˜¯é¢„è®¾è§’è‰²ï¼Œä»å·²æ·»åŠ é›†åˆä¸­ç§»é™¤
                if (presetId) {
                    addedChildrenIds.delete(presetId);
                    // æ›´æ–°èœå•ï¼Œè¯¥è§’è‰²å¯ä»¥å†æ¬¡æ·»åŠ 
                    updatePresetChildrenMenu();
                    console.log('âœ… å·²ç§»é™¤è§’è‰²:', presetId);
                }
            } else {
                alert('è‡³å°‘éœ€è¦ä¿ç•™ä¸€ä¸ªæµ‹è¯•è§’è‰²');
            }
        }

        // æ·»åŠ è¯„åˆ†æ ‡å‡†
        function addCriteria() {
            const container = document.getElementById('criteria-container');
            const criteriaItem = document.createElement('div');
            criteriaItem.className = 'criteria-item';
            criteriaItem.innerHTML = `
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <input type="text" class="form-control form-control-sm" style="width: 70%;" placeholder="è¯„åˆ†æ ‡å‡†åç§°" value="æ–°è¯„åˆ†æ ‡å‡†">
                    <button class="btn btn-sm btn-outline-danger" onclick="removeCriteria(this)"><i class="fas fa-trash"></i></button>
                </div>
                <textarea class="form-control form-control-sm" rows="3" placeholder="æè¿°å¦‚ä½•è¯„ä¼°è¿™ä¸ªæ ‡å‡†..." style="font-size: 0.85rem;"></textarea>
            `;
            container.appendChild(criteriaItem);
        }

        // åˆ é™¤è¯„åˆ†æ ‡å‡†
        function removeCriteria(button) {
            const criteriaItem = button.closest('.criteria-item');
            const criterionId = criteriaItem.getAttribute('data-criterion-id');
            
            if (document.querySelectorAll('.criteria-item').length > 1) {
                criteriaItem.remove();
                
                // å¦‚æœæ˜¯é¢„è®¾æ ‡å‡†ï¼Œä»å·²æ·»åŠ é›†åˆä¸­ç§»é™¤
                if (criterionId) {
                    // æ£€æŸ¥æ˜¯å¦æ˜¯å­æŒ‡æ ‡ï¼ˆåŒ…å«ç‚¹å·ï¼‰
                    if (criterionId.includes('.')) {
                        // å­æŒ‡æ ‡ï¼šåªç§»é™¤è¿™ä¸ªå­æŒ‡æ ‡
                        addedCriteriaIds.delete(criterionId);
                    } else {
                        // ä¸€çº§æŒ‡æ ‡ï¼šç§»é™¤æ•´ä¸ªæŒ‡æ ‡ç»„
                        addedCriteriaIds.delete(criterionId);
                    }
                    // æ›´æ–°èœå•ï¼Œè¯¥æ ‡å‡†å¯ä»¥å†æ¬¡æ·»åŠ 
                    updatePresetCriteriaMenu();
                    console.log('âœ… å·²ç§»é™¤è¯„åˆ†æ ‡å‡†:', criterionId);
                }
            } else {
                alert('è‡³å°‘éœ€è¦ä¿ç•™ä¸€ä¸ªè¯„åˆ†æ ‡å‡†');
            }
        }

        // è¿è¡Œæµ‹è¯•
        async function runTest() {
            // æ”¶é›†é…ç½®æ•°æ®
            const children = [];
            document.querySelectorAll('.child-card').forEach(card => {
                const inputs = card.querySelectorAll('input, textarea');
                children.push({
                    name: inputs[0].value,
                    age: parseInt(inputs[1].value),
                    traits: inputs[2].value,
                    opening: inputs[3].value
                });
            });

            // æ”¶é›†åŠ¨æ€è¯„åˆ†æ ‡å‡†
            const criteria = {};
            document.querySelectorAll('.criteria-item').forEach((item, index) => {
                const criterionId = item.getAttribute('data-criterion-id');
                
                // æ£€æŸ¥æ˜¯å¦æ˜¯ä¸€çº§æŒ‡æ ‡ï¼ˆæœ‰å­æŒ‡æ ‡ï¼‰
                const subCards = item.querySelectorAll('.card.border-secondary');
                if (subCards.length > 0) {
                    // ä¸€çº§æŒ‡æ ‡ï¼šæ„å»ºåŒ…å«å­æŒ‡æ ‡çš„ç»“æ„
                    const mainCard = item.querySelector('.card-header h6');
                    const mainName = mainCard ? mainCard.textContent.trim() : `ä¸€çº§æŒ‡æ ‡${index + 1}`;
                    const mainDescription = item.querySelector('.card-header small') ? item.querySelector('.card-header small').textContent.trim() : '';
                    
                    const subCriteria = {};
                    subCards.forEach(subCard => {
                        const subName = subCard.querySelector('.card-header h6').textContent.trim();
                        const subTextarea = subCard.querySelector('textarea');
                        const subPrompt = subTextarea ? subTextarea.value : '';
                        subCriteria[subName] = subPrompt;
                    });
                    
                    criteria[mainName] = {
                        name: mainName,
                        description: mainDescription,
                        sub_criteria: subCriteria
                    };
                } else {
                    // äºŒçº§æŒ‡æ ‡æˆ–æ—§æ ¼å¼ï¼šå•ä¸ªæŒ‡æ ‡
                    const nameInput = item.querySelector('input[type="text"]');
                    const textarea = item.querySelector('textarea');
                    const criteriaName = nameInput ? nameInput.value.trim() : `è¯„åˆ†æ ‡å‡†${index + 1}`;
                    
                    // æ£€æŸ¥æ˜¯å¦æ˜¯å­æŒ‡æ ‡ï¼ˆcriterionIdåŒ…å«ç‚¹å·ï¼‰
                    if (criterionId && criterionId.includes('.')) {
                        // å­æŒ‡æ ‡ï¼šæ„å»ºä¸ºå¹³çº§ç»“æ„ï¼Œä½†æ ‡è®°ä¸ºå­æŒ‡æ ‡
                        criteria[criteriaName] = textarea ? textarea.value : '';
                    } else {
                        // æ™®é€šæŒ‡æ ‡
                        criteria[criteriaName] = textarea ? textarea.value : '';
                    }
                }
            });

            // æ˜¾ç¤ºå®æ—¶è¿›åº¦
            showRealTimeProgress(children);

            // ä¾æ¬¡æµ‹è¯•æ¯ä¸ªè§’è‰²
            for (let i = 0; i < children.length; i++) {
                await runRealTimeTest(children[i], criteria, i);
            }
            
            // å¦‚æœæ˜¯è‡ªåŠ¨æµ‹è¯•æ¨¡å¼ï¼Œå®Œæˆåè‡ªåŠ¨å¼€å§‹ä¸‹ä¸€è½®
            if (isAutoTestRunning) {
                autoTestCount++;
                document.getElementById('test-count').textContent = autoTestCount;
                
                // ç­‰å¾…1ç§’åå¼€å§‹ä¸‹ä¸€è½®æµ‹è¯•
                setTimeout(() => {
                    if (isAutoTestRunning) {
                        console.log(`âœ… ç¬¬${autoTestCount}è½®æµ‹è¯•å®Œæˆï¼Œå‡†å¤‡å¼€å§‹ç¬¬${autoTestCount + 1}è½®...`);
                        runTest();  // é€’å½’è°ƒç”¨ï¼Œå¼€å§‹æ–°ä¸€è½®
                    }
                }, 1000);
            }
        }
        
        // ========== è‡ªåŠ¨æµ‹è¯•åŠŸèƒ½ ==========
        
        // å¯åŠ¨è‡ªåŠ¨å¾ªç¯æµ‹è¯•
        function startAutoTest() {
            if (isAutoTestRunning) {
                alert('è‡ªåŠ¨æµ‹è¯•å·²ç»åœ¨è¿è¡Œä¸­ï¼');
                return;
            }
            
            // ç¡®è®¤å¼€å§‹
            if (!confirm('ç¡®å®šè¦å¼€å§‹è‡ªåŠ¨å¾ªç¯æµ‹è¯•å—ï¼Ÿ\n\næµ‹è¯•å°†æŒç»­è¿è¡Œç›´åˆ°æ‚¨ç‚¹å‡»"æš‚åœ"æŒ‰é’®ã€‚\næ¯è½®æµ‹è¯•å®Œæˆåä¼šè‡ªåŠ¨å¼€å§‹ä¸‹ä¸€è½®ï¼Œæ‰€æœ‰æ•°æ®ä¼šæŒç»­ä¿å­˜ã€‚')) {
                return;
            }
            
            // è®¾ç½®çŠ¶æ€
            isAutoTestRunning = true;
            autoTestCount = 0;
            autoTestStartTime = new Date();
            
            // æ›´æ–°UI
            document.getElementById('auto-test-btn').style.display = 'none';
            document.getElementById('start-test-btn').style.display = 'none';
            document.getElementById('stop-auto-btn').style.display = 'block';
            document.getElementById('auto-test-stats').style.display = 'block';
            document.getElementById('test-status').textContent = 'è¿è¡Œä¸­';
            document.getElementById('test-count').textContent = '0';
            
            // å¯åŠ¨è®¡æ—¶å™¨
            autoTestTimer = setInterval(updateTestDuration, 1000);
            
            // å¼€å§‹ç¬¬ä¸€è½®æµ‹è¯•
            console.log('ğŸš€ è‡ªåŠ¨æµ‹è¯•å·²å¯åŠ¨');
            runTest();
        }
        
        // åœæ­¢è‡ªåŠ¨æµ‹è¯•
        function stopAutoTest() {
            if (!isAutoTestRunning) {
                return;
            }
            
            // ç¡®è®¤åœæ­¢
            if (!confirm(`ç¡®å®šè¦åœæ­¢è‡ªåŠ¨æµ‹è¯•å—ï¼Ÿ\n\nå·²å®Œæˆ ${autoTestCount} è½®æµ‹è¯•ã€‚`)) {
                return;
            }
            
            // è®¾ç½®çŠ¶æ€
            isAutoTestRunning = false;
            
            // æ¸…é™¤è®¡æ—¶å™¨
            if (autoTestTimer) {
                clearInterval(autoTestTimer);
                autoTestTimer = null;
            }
            
            // æ›´æ–°UI
            document.getElementById('auto-test-btn').style.display = 'block';
            document.getElementById('start-test-btn').style.display = 'block';
            document.getElementById('stop-auto-btn').style.display = 'none';
            document.getElementById('test-status').textContent = 'å·²åœæ­¢';
            
            console.log(`â¸ï¸ è‡ªåŠ¨æµ‹è¯•å·²åœæ­¢ï¼Œå…±å®Œæˆ ${autoTestCount} è½®æµ‹è¯•`);
            
            // 3ç§’åéšè—ç»Ÿè®¡ä¿¡æ¯
            setTimeout(() => {
                if (!isAutoTestRunning) {
                    document.getElementById('auto-test-stats').style.display = 'none';
                }
            }, 3000);
        }
        
        // æ›´æ–°è¿è¡Œæ—¶é—´æ˜¾ç¤º
        function updateTestDuration() {
            if (!autoTestStartTime) return;
            
            const now = new Date();
            const duration = Math.floor((now - autoTestStartTime) / 1000);
            
            const hours = Math.floor(duration / 3600);
            const minutes = Math.floor((duration % 3600) / 60);
            const seconds = duration % 60;
            
            const timeStr = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            document.getElementById('test-duration').textContent = timeStr;
        }

        // å®æ—¶å¯¹è¯æµ‹è¯•
        async function runRealTimeTest(child, criteria, childIndex) {
            const container = document.getElementById('results-container');
            const allCards = container.querySelectorAll('.result-card');
            const currentCard = allCards[childIndex];
            const conversationContainer = currentCard.querySelector('.conversation-container');
            const progressText = currentCard.querySelector('.progress-text');
            
            let conversationId = null;
            let currentMessage = child.opening;
            const conversationLog = [];
            
            // ä¸å†ä½¿ç”¨é¢„è®¾çš„å›åº”ï¼Œè€Œæ˜¯ä½¿ç”¨Geminiç”Ÿæˆ
            
            // è·å–ç”¨æˆ·è®¾ç½®çš„è½®æ•°
            const maxRounds = getRounds();
            
            // è¿›è¡Œå¯¹è¯æµ‹è¯•
            for (let round = 1; round <= maxRounds; round++) {
                // æ˜¾ç¤ºå½“å‰è½®æ¬¡çš„è¿›åº¦
                if (progressText) {
                    progressText.innerHTML = `<i class="fas fa-spinner fa-spin"></i> æ­£åœ¨è¿›è¡Œç¬¬${round}è½®å¯¹è¯... (${round}/${maxRounds})`;
                }
                
                try {
                    // è·å–APIå¯†é’¥
                    const apiKeys = getApiKeys();
                    
                    // è°ƒç”¨å•è½®å¯¹è¯API
                    const response = await fetch('/api/test-round', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            child: child,
                            criteria: criteria,
                            round_num: round,
                            conversation_id: conversationId,
                            message: currentMessage,
                            conversation_history: conversationLog,
                            ...apiKeys
                        })
                    });
                    
                    // å…ˆæ£€æŸ¥HTTPçŠ¶æ€ç 
                    if (!response.ok) {
                        // HTTPé”™è¯¯ï¼ˆåŒ…æ‹¬500ï¼‰
                        const errorResult = await response.json();
                        console.error('ç¬¬' + round + 'è½®HTTPé”™è¯¯:', errorResult);
                        alert('âŒ æµ‹è¯•å¤±è´¥ï¼\n\n' + (errorResult.message || 'ç¬¬' + round + 'è½®å¯¹è¯å¤±è´¥') + '\n\né”™è¯¯è¯¦æƒ…: ' + (errorResult.error || 'HTTP ' + response.status));
                        
                        // éšè—åŠ è½½çŠ¶æ€
                        document.querySelector('.loading').style.display = 'none';
                        return; // åœæ­¢æµ‹è¯•
                    }
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        // æ›´æ–°å¯¹è¯ID
                        conversationId = result.conversation_id;
                        
                        // ğŸ”¥ é¢å¤–éªŒè¯ï¼šç¡®ä¿ai_responseä¸ä¸ºç©ºä¸”ä¸æ˜¯é”™è¯¯æ¶ˆæ¯
                        if (!result.ai_response || result.ai_response.trim() === '' || 
                            result.ai_response.includes('è¿æ¥å¤±è´¥') || 
                            result.ai_response.includes('APIå¤±è´¥')) {
                            console.error('ç¬¬' + round + 'è½®æ£€æµ‹åˆ°æ— æ•ˆçš„AIå›å¤:', result.ai_response);
                            alert('âŒ æµ‹è¯•å¤±è´¥ï¼\n\nç¬¬' + round + 'è½®ï¼šAIå›å¤æ— æ•ˆæˆ–ä¸ºç©º\n\nè¯·æ£€æŸ¥Difyé…ç½®');
                            document.querySelector('.loading').style.display = 'none';
                            return; // åœæ­¢æµ‹è¯•
                        }
                        
                        // è®°å½•å¯¹è¯
                        const conversation = {
                            round: result.round,
                            user_message: result.user_message,
                            ai_response: result.ai_response,
                            timestamp: result.timestamp
                        };
                        conversationLog.push(conversation);
                        
                        // å®æ—¶æ˜¾ç¤ºè¿™ä¸€è½®å¯¹è¯
                        displaySingleRound(conversationContainer, conversation);
                        
                        // å‡†å¤‡ä¸‹ä¸€è½®æ¶ˆæ¯ï¼ˆä½¿ç”¨Geminiç”Ÿæˆå­©å­å›åº”ï¼‰
                        if (round < maxRounds) {
                            try {
                                const childResponse = await fetch('/api/generate-child-response', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json'
                                    },
                                    body: JSON.stringify({
                                        child: child,
                                        ai_response: result.ai_response,
                                        round_num: round + 1,
                                        conversation_history: conversationLog,
                                        ...apiKeys
                                    })
                                });
                                
                                const childResult = await childResponse.json();
                                if (childResult.success) {
                                    currentMessage = childResult.child_response;
                                } else {
                                    currentMessage = "æˆ‘æƒ³äº†è§£æ›´å¤šï¼";
                                }
                            } catch (error) {
                                console.error('ç”Ÿæˆå­©å­å›åº”å¤±è´¥:', error);
                                currentMessage = "æˆ‘æƒ³äº†è§£æ›´å¤šï¼";
                            }
                        }
                        
                        // æ·»åŠ å»¶è¿Ÿï¼Œè®©ç”¨æˆ·èƒ½çœ‹åˆ°å®æ—¶æ•ˆæœ
                        await new Promise(resolve => setTimeout(resolve, 1000));
                    } else {
                        // Dify APIå¤±è´¥ï¼Œå¼¹å‡ºé”™è¯¯å¹¶åœæ­¢æµ‹è¯•
                        console.error('ç¬¬' + round + 'è½®å¯¹è¯å¤±è´¥:', result.message);
                        alert('âŒ æµ‹è¯•å¤±è´¥ï¼\n\n' + result.message + '\n\né”™è¯¯è¯¦æƒ…: ' + (result.error || 'æœªçŸ¥é”™è¯¯'));
                        
                        // éšè—åŠ è½½çŠ¶æ€
                        document.querySelector('.loading').style.display = 'none';
                        return; // åœæ­¢æµ‹è¯•
                    }
                } catch (error) {
                    console.error('ç¬¬' + round + 'è½®å¯¹è¯å‡ºé”™:', error);
                    alert('âŒ ç½‘ç»œé”™è¯¯ï¼\n\nç¬¬' + round + 'è½®å¯¹è¯è¯·æ±‚å¤±è´¥\n\né”™è¯¯è¯¦æƒ…: ' + error.message);
                    
                    // éšè—åŠ è½½çŠ¶æ€
                    document.querySelector('.loading').style.display = 'none';
                    return; // åœæ­¢æµ‹è¯•
                }
            }
            
            // æ‰€æœ‰å¯¹è¯å®Œæˆåï¼Œè¿›è¡Œè¯„åˆ†
            await performFinalEvaluation(child, criteria, conversationLog, conversationContainer, progressText);
        }

        // æ˜¾ç¤ºå•è½®å¯¹è¯
        function displaySingleRound(container, conversation) {
            const roundHtml = `
                <div class="conversation-round mb-3 p-3 rounded" style="background-color: white; border-left: 4px solid #007bff;">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <strong>ç¬¬${conversation.round}è½®</strong>
                        <small class="text-muted">${conversation.timestamp}</small>
                    </div>
                    <div class="mb-2">
                        <strong>å­©å­ï¼š</strong><span class="text-primary">${conversation.user_message}</span>
                    </div>
                    <div>
                        <strong>AIï¼š</strong><span class="text-success">${conversation.ai_response}</span>
                    </div>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', roundHtml);
            
            // æ»šåŠ¨åˆ°æœ€æ–°å†…å®¹
            container.scrollTop = container.scrollHeight;
        }

        // æ‰§è¡Œæœ€ç»ˆè¯„åˆ†
        async function performFinalEvaluation(child, criteria, conversationLog, conversationContainer, progressText) {
            // æ˜¾ç¤ºè¯„åˆ†ä¸­çŠ¶æ€
            if (progressText) {
                progressText.innerHTML = '<i class="fas fa-spinner fa-spin"></i> æ­£åœ¨è¿›è¡Œæœ€ç»ˆè¯„åˆ†...';
            }
            
            try {
                // è·å–APIå¯†é’¥
                const apiKeys = getApiKeys();
                
                // è°ƒç”¨åç«¯è¯„åˆ†API
                const response = await fetch('/api/evaluate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        child: child,
                        conversation_history: conversationLog,
                        criteria: criteria,
                        ...apiKeys
                    })
                });
                
                const evalResult = await response.json();
                
                const result = {
                    child: child.name,
                    age: child.age,
                    traits: child.traits,
                    opening: child.opening,
                    conversation_log: conversationLog,
                    scores: evalResult.scores || {},
                    score_details: evalResult.score_details || {},
                    reason: evalResult.reason || "è¯„åˆ†å®Œæˆ",
                    lessons: evalResult.lessons || "æš‚æ— ç»éªŒæ•™è®­",
                    character_review: evalResult.character_review || "",
                    experience_score: evalResult.experience_score || 50,
                    timestamp: new Date().toLocaleString()
                };
                
                // æ˜¾ç¤ºæœ€ç»ˆç»“æœ
                displayFinalResults(conversationContainer, result, progressText);
                
                // ä¿å­˜åˆ°CSV
                await saveResultToCSV(child, criteria, conversationLog, evalResult.scores, evalResult.reason, evalResult.lessons, evalResult.character_review, evalResult.experience_score);
                
            } catch (error) {
                console.error('è¯„åˆ†è¿‡ç¨‹å‡ºé”™:', error);
                // å¦‚æœè¯„åˆ†å¤±è´¥ï¼Œä»ç„¶æ˜¾ç¤ºå¯¹è¯è®°å½•
                const result = {
                    child: child.name,
                    age: child.age,
                    traits: child.traits,
                    opening: child.opening,
                    conversation_log: conversationLog,
                    scores: {},
                    score_details: {},
                    reason: "è¯„åˆ†è¿‡ç¨‹å‡ºé”™ï¼š" + error.message,
                    lessons: "è¯„åˆ†å¤±è´¥ï¼Œæ— æ³•ç”Ÿæˆç»éªŒæ•™è®­",
                    character_review: "",
                    experience_score: 50,
                    timestamp: new Date().toLocaleString()
                };
                displayFinalResults(conversationContainer, result, progressText);
                
                // å³ä½¿è¯„åˆ†å¤±è´¥ï¼Œä¹Ÿä¿å­˜å¯¹è¯è®°å½•åˆ°CSV
                await saveResultToCSV(child, criteria, conversationLog, {}, "è¯„åˆ†è¿‡ç¨‹å‡ºé”™ï¼š" + error.message, "", "", 50);
            }
        }

        // æ˜¾ç¤ºæœ€ç»ˆç»“æœ
        function displayFinalResults(container, result, progressText) {
            const scores = result.scores || {};
            const scoreDetails = result.score_details || {};
            const scoreKeys = Object.keys(scores);
            
            // ç”Ÿæˆæ¯ä¸ªè¯„åˆ†æ ‡å‡†çš„è¯¦ç»†å¡ç‰‡
            const scoreDetailsHtml = scoreKeys.map((key, i) => {
                const score = scores[key] || 0;
                let detail = scoreDetails[key] || 'æš‚æ— è¯¦ç»†ç†ç”±';
                // ç¡®ä¿detailæ˜¯å­—ç¬¦ä¸²
                if (typeof detail !== 'string') {
                    detail = String(detail) || 'æš‚æ— è¯¦ç»†ç†ç”±';
                }
                
                // æ£€æŸ¥æ˜¯å¦æ˜¯ä¸€çº§æŒ‡æ ‡ï¼ˆåŒ…å«å­æŒ‡æ ‡ï¼‰
                const isMainCriteria = key.includes('.');
                const displayName = isMainCriteria ? key.split('.')[1] : key;
                const mainCriteriaName = isMainCriteria ? key.split('.')[0] : null;
                
                const colors = ['primary', 'success', 'warning', 'info', 'danger', 'secondary', 'dark'];
                const color = colors[i % colors.length];
                
                // æ ¹æ®åˆ†æ•°é€‰æ‹©å›¾æ ‡
                let icon = 'fa-star';
                if (score >= 9) icon = 'fa-star text-warning';
                else if (score >= 7) icon = 'fa-check-circle text-success';
                else if (score >= 5) icon = 'fa-minus-circle text-primary';
                else icon = 'fa-times-circle text-danger';
                
                // å¦‚æœæ˜¯ä¸€çº§æŒ‡æ ‡çš„å­æŒ‡æ ‡ï¼Œæ·»åŠ ç‰¹æ®Šæ ·å¼
                const cardClass = isMainCriteria ? 'border-start border-4 border-primary' : '';
                const headerClass = isMainCriteria ? 'bg-light text-dark' : `bg-${color} text-white`;
                
                return `
                    <div class="card mb-2 ${cardClass}">
                        <div class="card-header ${headerClass} d-flex justify-content-between align-items-center">
                            <span>
                                <i class="fas ${icon}"></i> 
                                ${isMainCriteria ? `<small class="text-muted">${mainCriteriaName} â†’ </small>` : ''}
                                ${displayName}
                            </span>
                            <span class="badge ${isMainCriteria ? 'bg-primary' : 'bg-light text-dark'}">${score} åˆ†</span>
                        </div>
                        <div class="card-body">
                            <small style="white-space: pre-wrap;">${detail}</small>
                        </div>
                    </div>
                `;
            }).join('');
            
            // æ ¼å¼åŒ–ç»éªŒæ•™è®­ï¼ˆä¿ç•™æ¢è¡Œå’Œåˆ—è¡¨æ ¼å¼ï¼‰
            // ç¡®ä¿lessonsæ˜¯å­—ç¬¦ä¸²ç±»å‹
            let lessonsText = result.lessons || 'æ— ';
            if (typeof lessonsText !== 'string') {
                lessonsText = JSON.stringify(lessonsText) || 'æ— ';
            }
            const lessonsFormatted = lessonsText.replace(/\n/g, '<br>');
            
            // ç¡®ä¿reasonä¹Ÿæ˜¯å­—ç¬¦ä¸²
            let reasonText = result.reason || 'æ— ';
            if (typeof reasonText !== 'string') {
                reasonText = String(reasonText) || 'æ— ';
            }
            
            // ç¡®ä¿character_reviewä¹Ÿæ˜¯å­—ç¬¦ä¸²
            let characterReviewText = result.character_review || '';
            if (typeof characterReviewText !== 'string') {
                characterReviewText = String(characterReviewText) || '';
            }
            const characterReviewFormatted = characterReviewText.replace(/\n/g, '<br>');
            
            // åªæœ‰å½“æœ‰è§’è‰²è‡ªè¿°æ—¶æ‰æ˜¾ç¤ºè§’è‰²è‡ªè¿°å¡ç‰‡
            const characterReviewHtml = characterReviewText ? `
                <div class="card border-success mb-2">
                    <div class="card-header bg-success text-white">
                        <i class="fas fa-child"></i> è§’è‰²è‡ªè¿°ï¼ˆ${result.child}çš„æ„Ÿå—ï¼‰
                    </div>
                    <div class="card-body" style="background-color: #f0f8ff;">
                        <small style="white-space: pre-wrap; font-style: italic;">"${characterReviewFormatted}"</small>
                    </div>
                </div>
            ` : '';
            
            // ä½“éªŒè¯„åˆ†æ˜¾ç¤ºï¼ˆä½¿ç”¨ ?? é¿å… 0 è¢«å½“ä½œ falsy å€¼ï¼‰
            const experienceScore = result.experience_score ?? 50;
            let experienceColor = 'secondary';
            let experienceIcon = 'meh';
            let experienceText = 'ä¸€èˆ¬';
            
            if (experienceScore >= 90) {
                experienceColor = 'success';
                experienceIcon = 'grin-stars';
                experienceText = 'è¶…çº§å¼€å¿ƒ';
            } else if (experienceScore >= 70) {
                experienceColor = 'primary';
                experienceIcon = 'smile';
                experienceText = 'æŒºå¥½çš„';
            } else if (experienceScore >= 50) {
                experienceColor = 'info';
                experienceIcon = 'meh';
                experienceText = 'è¿˜è¡Œå§';
            } else if (experienceScore >= 30) {
                experienceColor = 'warning';
                experienceIcon = 'frown';
                experienceText = 'æœ‰ç‚¹æ— èŠ';
            } else {
                experienceColor = 'danger';
                experienceIcon = 'sad-tear';
                experienceText = 'å¾ˆä¸å–œæ¬¢';
            }
            
            const experienceScoreHtml = `
                <div class="card border-${experienceColor} mb-2">
                    <div class="card-header bg-${experienceColor} text-white">
                        <i class="fas fa-heart"></i> è§’è‰²ä½“éªŒè¯„åˆ†
                    </div>
                    <div class="card-body text-center">
                        <h2 class="text-${experienceColor} mb-2">
                            <i class="fas fa-${experienceIcon}"></i> ${experienceScore} <small>/ 100</small>
                        </h2>
                        <p class="mb-0"><strong>${experienceText}</strong></p>
                        <small class="text-muted">å­©å­è§†è§’çš„æ•´ä½“ä½“éªŒè¯„åˆ†</small>
                    </div>
                </div>
            `;
            
            const finalHtml = `
                <div class="mt-4">
                    <h6 class="mb-3"><i class="fas fa-star"></i> ğŸ“Š è¯¦ç»†è¯„åˆ†ç»“æœ</h6>
                    ${scoreDetailsHtml}
                    
                    <div class="card mb-2 border-info">
                        <div class="card-header bg-info text-white">
                            <i class="fas fa-lightbulb"></i> æ€»ä½“è¯„ä»·
                        </div>
                        <div class="card-body">
                            <small style="white-space: pre-wrap;">${reasonText}</small>
                        </div>
                    </div>
                    
                    <div class="card border-warning mb-2">
                        <div class="card-header bg-warning text-dark">
                            <i class="fas fa-book"></i> ç»éªŒæ•™è®­
                        </div>
                        <div class="card-body">
                            <small style="white-space: pre-wrap;">${lessonsFormatted}</small>
                                </div>
                    </div>
                    
                    ${characterReviewHtml}
                    ${experienceScoreHtml}
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', finalHtml);
            
            // æ›´æ–°è¿›åº¦æ–‡æœ¬
            if (progressText) {
                progressText.innerHTML = '<i class="fas fa-check-circle"></i> æµ‹è¯•å®Œæˆï¼';
            }
        }

        // ä¿å­˜ç»“æœåˆ°CSV
        async function saveResultToCSV(child, criteria, conversationLog, scores, reason, lessons, character_review, experience_score) {
            try {
                const response = await fetch('/api/save-result', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        child: child,
                        criteria: criteria,
                        conversations: conversationLog,
                        scores: scores || {},
                        reason: reason || '',
                        lessons: lessons || '',
                        character_review: character_review || '',
                        experience_score: experience_score || 50,
                        timestamp: new Date().toLocaleString('zh-CN', {
                            year: 'numeric',
                            month: '2-digit',
                            day: '2-digit',
                            hour: '2-digit',
                            minute: '2-digit',
                            second: '2-digit'
                        })
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    console.log('âœ… æµ‹è¯•ç»“æœå·²ä¿å­˜åˆ°CSV');
                } else {
                    console.error('âŒ ä¿å­˜CSVå¤±è´¥:', result.message);
                }
            } catch (error) {
                console.error('âŒ ä¿å­˜CSVå‡ºé”™:', error);
            }
        }

        // æ˜¾ç¤ºå®æ—¶è¿›åº¦
        function showRealTimeProgress(children) {
            const container = document.getElementById('results-container');
            const maxRounds = getRounds();
            let html = '<div class="row">';
            
            children.forEach((child, index) => {
                html += `
                    <div class="col-md-12 mb-4">
                        <div class="card result-card">
                            <div class="card-header">
                                <h5><i class="fas fa-child"></i> ${child.name} (${child.age}å²) - ${maxRounds}è½®å¯¹è¯</h5>
                            </div>
                            <div class="card-body">
                                <p><strong>æ€§æ ¼ç‰¹ç‚¹ï¼š</strong>${child.traits}</p>
                                <p><strong>å¼€åœºç™½ï¼š</strong>${child.opening}</p>
                                <hr>
                                <h6><i class="fas fa-comments"></i> å¯¹è¯è®°å½•ï¼š</h6>
                                <div class="progress-text text-center text-primary mb-3">
                                    <i class="fas fa-spinner fa-spin"></i> å‡†å¤‡å¼€å§‹å¯¹è¯æµ‹è¯•...
                                </div>
                                <div class="conversation-container" style="max-height: 400px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 5px; padding: 15px; background-color: #f8f9fa;">
                                    <div class="text-center text-muted">
                                        <p>ç­‰å¾…å¯¹è¯å¼€å§‹...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }

        // å­˜å‚¨å½“å‰ç»“æœ
        let currentResults = [];

        // æ˜¾ç¤ºç»“æœ
        function displayResults(results) {
            currentResults = results; // ä¿å­˜ç»“æœ
            const container = document.getElementById('results-container');
            const maxRounds = getRounds();
            let html = '<div class="row">';
            
            results.forEach((result, index) => {
                const scores = result.scores || {};
                const scoreKeys = Object.keys(scores);
                const conversationLog = result.conversation_log || [];
                
                html += `
                    <div class="col-md-12 mb-4">
                        <div class="card result-card">
                            <div class="card-header">
                                <h5><i class="fas fa-child"></i> ${result.child} (${result.age}å²) - ${maxRounds}è½®å¯¹è¯</h5>
                            </div>
                            <div class="card-body">
                                <p><strong>æ€§æ ¼ç‰¹ç‚¹ï¼š</strong>${result.traits}</p>
                                <p><strong>å¼€åœºç™½ï¼š</strong>${result.opening}</p>
                                <hr>
                                <h6><i class="fas fa-comments"></i> å¯¹è¯è®°å½•ï¼š</h6>
                                <div class="conversation-container" style="max-height: 400px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 5px; padding: 15px; background-color: #f8f9fa;">
                `;
                
                // æ˜¾ç¤ºæ¯è½®å¯¹è¯
                conversationLog.forEach((conversation, roundIndex) => {
                    html += `
                        <div class="conversation-round mb-3 p-3 rounded" style="background-color: white; border-left: 4px solid #007bff;">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <strong>ç¬¬${conversation.round}è½®</strong>
                                <small class="text-muted">${conversation.timestamp}</small>
                            </div>
                            <div class="mb-2">
                                <strong>å­©å­ï¼š</strong><span class="text-primary">${conversation.user_message}</span>
                            </div>
                            <div>
                                <strong>AIï¼š</strong><span class="text-success">${conversation.ai_response}</span>
                            </div>
                        </div>
                    `;
                });
                
                html += `
                                </div>
                                <hr>
                                <div class="row text-center">
                `;
                
                // åŠ¨æ€æ˜¾ç¤ºè¯„åˆ†
                scoreKeys.forEach((key, i) => {
                    const colors = ['bg-primary', 'bg-success', 'bg-warning', 'bg-info', 'bg-danger', 'bg-secondary'];
                    const color = colors[i % colors.length];
                    html += `
                        <div class="col-${Math.floor(12 / scoreKeys.length)}">
                            <span class="badge ${color} score-badge">${key}: ${scores[key] || 0}</span>
                        </div>
                    `;
                });
                
                html += `
                                </div>
                                <p class="mt-2"><small class="text-muted">${result.reason}</small></p>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }

        // æ¸…ç©ºç»“æœ
        function clearResults() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰ç»“æœå—ï¼Ÿ')) {
                currentResults = [];
                document.getElementById('results-container').innerHTML = `
                    <div class="text-center text-muted">
                        <i class="fas fa-clipboard-list fa-3x mb-3"></i>
                        <p>é…ç½®æµ‹è¯•è§’è‰²å’Œè¯„åˆ†æ ‡å‡†ï¼Œç„¶åç‚¹å‡»"å¼€å§‹æµ‹è¯•"</p>
                    </div>
                `;
            }
        }
    </script>
</body>
</html>
