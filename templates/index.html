<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å„¿ç«¥AIå¯¹è¯æµ‹è¯•å¹³å°</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .card {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border: none;
            margin-bottom: 20px;
        }
        .card-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
        }
        .btn-primary:hover {
            background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
        }
        .result-card {
            border-left: 4px solid #28a745;
        }
        .score-badge {
            font-size: 1.2em;
            padding: 8px 16px;
        }
        .loading {
            display: none;
        }
        .child-card {
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }
        .child-card:hover {
            border-color: #667eea;
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.2);
        }
        .criteria-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- å·¦ä¾§é…ç½®é¢æ¿ -->
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h4><i class="fas fa-cog"></i> æµ‹è¯•é…ç½®</h4>
                    </div>
                    <div class="card-body">
                        <!-- æµ‹è¯•è§’è‰²é…ç½® -->
                        <h5><i class="fas fa-child"></i> æµ‹è¯•è§’è‰²</h5>
                        <div id="children-container">
                            <!-- é»˜è®¤è§’è‰²å°†è‡ªåŠ¨åŠ è½½ -->
                        </div>
                        <div class="d-flex gap-2 mb-3">
                            <button class="btn btn-outline-primary btn-sm" onclick="addChild()">
                                <i class="fas fa-plus"></i> æ·»åŠ è‡ªå®šä¹‰è§’è‰²
                            </button>
                            <div class="dropdown">
                                <button class="btn btn-primary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                    <i class="fas fa-user-plus"></i> å¿«é€Ÿæ·»åŠ å†…ç½®è§’è‰²
                                </button>
                                <ul class="dropdown-menu" id="preset-children-menu">
                                    <li><a class="dropdown-item text-muted" href="#">åŠ è½½ä¸­...</a></li>
                                </ul>
                            </div>
                        </div>

                        <!-- è¯„åˆ†æ ‡å‡†é…ç½® -->
                        <h5 class="mt-4"><i class="fas fa-chart-line"></i> è¯„åˆ†æ ‡å‡†</h5>
                        <div id="criteria-container">
                            <!-- é»˜è®¤è¯„åˆ†æ ‡å‡†å°†è‡ªåŠ¨åŠ è½½ -->
                        </div>
                        <div class="d-flex gap-2 mb-3">
                            <button class="btn btn-outline-primary btn-sm" onclick="addCriteria()">
                                <i class="fas fa-plus"></i> æ·»åŠ è‡ªå®šä¹‰æ ‡å‡†
                            </button>
                            <div class="dropdown">
                                <button class="btn btn-success btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                    <i class="fas fa-star"></i> å¿«é€Ÿæ·»åŠ å†…ç½®æ ‡å‡†
                                </button>
                                <ul class="dropdown-menu" id="preset-criteria-menu">
                                    <li><a class="dropdown-item text-muted" href="#">åŠ è½½ä¸­...</a></li>
                                </ul>
                            </div>
                        </div>

                        <!-- æ“ä½œæŒ‰é’® -->
                        <div class="d-grid gap-2 mt-4">
                            <button class="btn btn-primary" onclick="runTest()">
                                <i class="fas fa-play"></i> å¼€å§‹æµ‹è¯•
                            </button>
                            <button class="btn btn-warning" onclick="clearResults()">
                                <i class="fas fa-trash"></i> æ¸…ç©ºç»“æœ
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å³ä¾§ç»“æœé¢æ¿ -->
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h4 class="mb-0"><i class="fas fa-chart-bar"></i> æµ‹è¯•ç»“æœ</h4>
                        <button class="btn btn-outline-light btn-sm" data-bs-toggle="modal" data-bs-target="#settingsModal">
                            <i class="fas fa-cog"></i> è®¾ç½®
                        </button>
                    </div>
                    <div class="card-body">
                        <!-- åŠ è½½çŠ¶æ€ -->
                        <div class="loading text-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">æµ‹è¯•ä¸­...</span>
                            </div>
                            <p class="mt-2">æ­£åœ¨è¿è¡Œæµ‹è¯•ï¼Œè¯·ç¨å€™...</p>
                        </div>

                        <!-- ç»“æœå±•ç¤º -->
                        <div id="results-container">
                            <div class="text-center text-muted">
                                <i class="fas fa-clipboard-list fa-3x mb-3"></i>
                                <p>é…ç½®æµ‹è¯•è§’è‰²å’Œè¯„åˆ†æ ‡å‡†ï¼Œç„¶åç‚¹å‡»"å¼€å§‹æµ‹è¯•"</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- è®¾ç½®æ¨¡æ€å¼¹çª— -->
    <div class="modal fade" id="settingsModal" tabindex="-1" aria-labelledby="settingsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="settingsModalLabel">
                        <i class="fas fa-cog"></i> é«˜çº§è®¾ç½®
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- APIå¯†é’¥é…ç½® -->
                    <h5 class="mb-3"><i class="fas fa-key"></i> APIå¯†é’¥é…ç½®</h5>
                    <div class="card mb-4">
                        <div class="card-body">
                            <div class="mb-3">
                                <label for="dify-api-key" class="form-label">
                                    <strong>Dify API Key</strong>
                                    <small class="text-muted">(å¯é€‰ï¼Œç•™ç©ºä½¿ç”¨é»˜è®¤é…ç½®)</small>
                                </label>
                                <div class="input-group">
                                    <input type="password" class="form-control" id="dify-api-key" placeholder="ç•™ç©ºä½¿ç”¨é»˜è®¤å¯†é’¥">
                                    <button class="btn btn-outline-secondary" type="button" onclick="togglePasswordVisibility('dify-api-key')">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                                <small class="form-text text-muted">ç”¨äºè¿æ¥Dify Agent</small>
                            </div>
                            <div class="mb-0">
                                <label for="gemini-api-key" class="form-label">
                                    <strong>Gemini API Key</strong>
                                    <small class="text-muted">(å¯é€‰ï¼Œç•™ç©ºä½¿ç”¨é»˜è®¤é…ç½®)</small>
                                </label>
                                <div class="input-group">
                                    <input type="password" class="form-control" id="gemini-api-key" placeholder="ç•™ç©ºä½¿ç”¨é»˜è®¤å¯†é’¥">
                                    <button class="btn btn-outline-secondary" type="button" onclick="togglePasswordVisibility('gemini-api-key')">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                                <small class="form-text text-muted">ç”¨äºç”Ÿæˆå­©å­å›å¤å’Œè¯„åˆ†</small>
                            </div>
                        </div>
                    </div>

                    <!-- å¯¹è¯è½®æ•°è®¾ç½® -->
                    <h5 class="mb-3"><i class="fas fa-sync-alt"></i> å¯¹è¯è½®æ•°è®¾ç½®</h5>
                    <div class="card mb-3">
                        <div class="card-body">
                            <label for="rounds-input" class="form-label">
                                <strong>æ¯ä¸ªè§’è‰²æµ‹è¯•è½®æ•°</strong>
                            </label>
                            <input type="number" class="form-control" id="rounds-input" min="1" max="10" value="3">
                            <small class="form-text text-muted">å»ºè®®1-10è½®ï¼Œé»˜è®¤3è½®ã€‚è½®æ•°è¶Šå¤šï¼Œå¯¹è¯è¶Šæ·±å…¥ï¼Œä½†æµ‹è¯•æ—¶é—´ä¹Ÿè¶Šé•¿ã€‚</small>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> å…³é—­
                    </button>
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">
                        <i class="fas fa-check"></i> ä¿å­˜è®¾ç½®
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // åˆ‡æ¢å¯†ç å¯è§æ€§
        function togglePasswordVisibility(inputId) {
            const input = document.getElementById(inputId);
            const button = input.nextElementSibling;
            const icon = button.querySelector('i');
            
            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                input.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        }
        
        // è·å–ç”¨æˆ·è®¾ç½®çš„APIå¯†é’¥
        function getApiKeys() {
            const difyKey = document.getElementById('dify-api-key').value.trim();
            const geminiKey = document.getElementById('gemini-api-key').value.trim();
            
            return {
                dify_api_key: difyKey || null,  // å¦‚æœä¸ºç©ºï¼Œåç«¯ä½¿ç”¨é»˜è®¤å€¼
                gemini_api_key: geminiKey || null
            };
        }
        
        // è·å–ç”¨æˆ·è®¾ç½®çš„å¯¹è¯è½®æ•°
        function getRounds() {
            return parseInt(document.getElementById('rounds-input').value) || 3;
        }
        
        // å†…ç½®è§’è‰²æ•°æ®ï¼ˆä»APIåŠ è½½ï¼‰
        let presetChildren = {};
        // å·²æ·»åŠ çš„è§’è‰²IDé›†åˆ
        let addedChildrenIds = new Set();

        // ä»APIåŠ è½½å†…ç½®è§’è‰²æ•°æ®
        async function loadPresetChildren() {
            try {
                const response = await fetch('/api/preset-children');
                if (response.ok) {
                    presetChildren = await response.json();
                    updatePresetChildrenMenu();
                    console.log('âœ… å†…ç½®è§’è‰²åŠ è½½æˆåŠŸ:', Object.keys(presetChildren).length, 'ä¸ªè§’è‰²');
                    
                    // è‡ªåŠ¨æ·»åŠ ç¬¬ä¸€ä¸ªé¢„è®¾è§’è‰²ä½œä¸ºé»˜è®¤è§’è‰²
                    const firstPresetId = Object.keys(presetChildren)[0];
                    if (firstPresetId) {
                        addPresetChild(firstPresetId);
                        addedChildrenIds.add(firstPresetId);
                        console.log('âœ… å·²è‡ªåŠ¨æ·»åŠ é»˜è®¤è§’è‰²:', presetChildren[firstPresetId].name);
                        // æ›´æ–°èœå•ä»¥æ’é™¤å·²æ·»åŠ çš„è§’è‰²
                        updatePresetChildrenMenu();
                    }
                } else {
                    console.error('âŒ åŠ è½½å†…ç½®è§’è‰²å¤±è´¥:', response.status);
                }
            } catch (error) {
                console.error('âŒ åŠ è½½å†…ç½®è§’è‰²å¼‚å¸¸:', error);
            }
        }

        // æ›´æ–°å†…ç½®è§’è‰²ä¸‹æ‹‰èœå•
        function updatePresetChildrenMenu() {
            const menu = document.getElementById('preset-children-menu');
            if (!menu) return;
            
            menu.innerHTML = '';
            
            // è¿‡æ»¤æ‰å·²æ·»åŠ çš„è§’è‰²
            const availableChildren = Object.entries(presetChildren).filter(([id, child]) => !addedChildrenIds.has(id));
            
            if (availableChildren.length === 0) {
                menu.innerHTML = '<li><a class="dropdown-item text-muted" href="#">æ‰€æœ‰è§’è‰²å·²æ·»åŠ </a></li>';
                return;
            }
            
            // åŠ¨æ€ç”Ÿæˆèœå•é¡¹ï¼ˆåªæ˜¾ç¤ºæœªæ·»åŠ çš„è§’è‰²ï¼‰
            for (const [id, child] of availableChildren) {
                const menuItem = document.createElement('li');
                menuItem.innerHTML = `
                    <a class="dropdown-item" href="#" onclick="addPresetChild('${id}'); return false;">
                        ${child.emoji || 'ğŸ§’'} ${child.name} - ${child.type || 'æµ‹è¯•å‹'}
                    </a>
                `;
                menu.appendChild(menuItem);
            }
        }

        // å†…ç½®è¯„åˆ†æ ‡å‡†æ•°æ®ï¼ˆä»APIåŠ è½½ï¼‰
        let presetCriteria = {};
        // å·²æ·»åŠ çš„è¯„åˆ†æ ‡å‡†IDé›†åˆ
        let addedCriteriaIds = new Set();

        // ä»APIåŠ è½½å†…ç½®è¯„åˆ†æ ‡å‡†æ•°æ®
        async function loadPresetCriteria() {
            try {
                const response = await fetch('/api/preset-criteria');
                if (response.ok) {
                    presetCriteria = await response.json();
                    updatePresetCriteriaMenu();
                    console.log('âœ… å†…ç½®è¯„åˆ†æ ‡å‡†åŠ è½½æˆåŠŸ:', Object.keys(presetCriteria).length, 'ä¸ªæ ‡å‡†');
                    
                    // è‡ªåŠ¨æ·»åŠ å‰ä¸‰ä¸ªé¢„è®¾è¯„åˆ†æ ‡å‡†ä½œä¸ºé»˜è®¤æ ‡å‡†
                    const criteriaIds = Object.keys(presetCriteria);
                    const defaultCriteriaCount = Math.min(3, criteriaIds.length);
                    for (let i = 0; i < defaultCriteriaCount; i++) {
                        addPresetCriterion(criteriaIds[i]);
                        addedCriteriaIds.add(criteriaIds[i]);
                    }
                    console.log(`âœ… å·²è‡ªåŠ¨æ·»åŠ é»˜è®¤è¯„åˆ†æ ‡å‡†: ${defaultCriteriaCount} ä¸ª`);
                    // æ›´æ–°èœå•ä»¥æ’é™¤å·²æ·»åŠ çš„æ ‡å‡†
                    updatePresetCriteriaMenu();
                } else {
                    console.error('âŒ åŠ è½½å†…ç½®è¯„åˆ†æ ‡å‡†å¤±è´¥:', response.status);
                }
            } catch (error) {
                console.error('âŒ åŠ è½½å†…ç½®è¯„åˆ†æ ‡å‡†å¼‚å¸¸:', error);
            }
        }

        // æ›´æ–°å†…ç½®è¯„åˆ†æ ‡å‡†ä¸‹æ‹‰èœå•
        function updatePresetCriteriaMenu() {
            const menu = document.getElementById('preset-criteria-menu');
            if (!menu) return;
            
            menu.innerHTML = '';
            
            // è¿‡æ»¤æ‰å·²æ·»åŠ çš„æ ‡å‡†
            const availableCriteria = Object.entries(presetCriteria).filter(([id, criterion]) => !addedCriteriaIds.has(id));
            
            if (availableCriteria.length === 0) {
                menu.innerHTML = '<li><a class="dropdown-item text-muted" href="#">æ‰€æœ‰æ ‡å‡†å·²æ·»åŠ </a></li>';
                return;
            }
            
            // åŠ¨æ€ç”Ÿæˆèœå•é¡¹ï¼ˆåªæ˜¾ç¤ºæœªæ·»åŠ çš„æ ‡å‡†ï¼‰
            for (const [id, criterion] of availableCriteria) {
                const menuItem = document.createElement('li');
                menuItem.innerHTML = `
                    <a class="dropdown-item" href="#" onclick="addPresetCriterion('${id}'); return false;">
                        â­ ${criterion.name}
                    </a>
                `;
                menu.appendChild(menuItem);
            }
        }

        // æ·»åŠ é¢„è®¾è¯„åˆ†æ ‡å‡†
        function addPresetCriterion(criterionId) {
            const criterion = presetCriteria[criterionId];
            if (!criterion) return;
            
            // é˜²æ­¢é‡å¤æ·»åŠ 
            if (addedCriteriaIds.has(criterionId)) {
                console.log('âš ï¸ è¯„åˆ†æ ‡å‡†å·²å­˜åœ¨ï¼Œä¸é‡å¤æ·»åŠ :', criterion.name);
                return;
            }
            
            const container = document.getElementById('criteria-container');
            const criteriaItem = document.createElement('div');
            criteriaItem.className = 'criteria-item';
            criteriaItem.setAttribute('data-criterion-id', criterionId); // ä¿å­˜IDç”¨äºåˆ é™¤æ—¶è¯†åˆ«
            criteriaItem.innerHTML = `
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <input type="text" class="form-control form-control-sm" style="width: 70%;" placeholder="è¯„åˆ†æ ‡å‡†åç§°" value="${criterion.name}">
                    <button class="btn btn-sm btn-outline-danger" onclick="removeCriteria(this)"><i class="fas fa-trash"></i></button>
                </div>
                <textarea class="form-control" rows="5" placeholder="æè¿°å¦‚ä½•è¯„ä¼°è¿™ä¸ªæ ‡å‡†...">${criterion.prompt}</textarea>
            `;
            container.appendChild(criteriaItem);
            
            // è®°å½•å·²æ·»åŠ çš„æ ‡å‡†ID
            addedCriteriaIds.add(criterionId);
            // æ›´æ–°èœå•ï¼Œæ’é™¤å·²æ·»åŠ çš„æ ‡å‡†
            updatePresetCriteriaMenu();
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨åŠ è½½å†…ç½®è§’è‰²å’Œè¯„åˆ†æ ‡å‡†
        document.addEventListener('DOMContentLoaded', function() {
            loadPresetChildren();
            loadPresetCriteria();
        });

        // æ·»åŠ é¢„è®¾è§’è‰²
        function addPresetChild(presetId) {
            const preset = presetChildren[presetId];
            if (!preset) return;
            
            // é˜²æ­¢é‡å¤æ·»åŠ 
            if (addedChildrenIds.has(presetId)) {
                console.log('âš ï¸ è§’è‰²å·²å­˜åœ¨ï¼Œä¸é‡å¤æ·»åŠ :', preset.name);
                return;
            }
            
            const container = document.getElementById('children-container');
            const childCard = document.createElement('div');
            childCard.className = 'child-card';
            childCard.setAttribute('data-preset-id', presetId); // ä¿å­˜IDç”¨äºåˆ é™¤æ—¶è¯†åˆ«
            childCard.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <input type="text" class="form-control mb-2" placeholder="å§“å" value="${preset.name}">
                    </div>
                    <div class="col-md-6">
                        <input type="number" class="form-control mb-2" placeholder="å¹´é¾„" value="${preset.age}">
                    </div>
                </div>
                <textarea class="form-control mb-2" placeholder="æ€§æ ¼ç‰¹ç‚¹" rows="4">${preset.traits}</textarea>
                <textarea class="form-control mb-2" placeholder="å¼€åœºç™½" rows="2">${preset.opening}</textarea>
                <button class="btn btn-sm btn-danger" onclick="removeChildCard(this)"><i class="fas fa-trash"></i> åˆ é™¤</button>
            `;
            container.appendChild(childCard);
            
            // è®°å½•å·²æ·»åŠ çš„è§’è‰²ID
            addedChildrenIds.add(presetId);
            // æ›´æ–°èœå•ï¼Œæ’é™¤å·²æ·»åŠ çš„è§’è‰²
            updatePresetChildrenMenu();
        }
        
        // æ·»åŠ è‡ªå®šä¹‰æµ‹è¯•è§’è‰²
        function addChild() {
            const container = document.getElementById('children-container');
            const childCard = document.createElement('div');
            childCard.className = 'child-card';
            childCard.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <input type="text" class="form-control mb-2" placeholder="å§“å" value="æ–°è§’è‰²">
                    </div>
                    <div class="col-md-6">
                        <input type="number" class="form-control mb-2" placeholder="å¹´é¾„" value="8">
                    </div>
                </div>
                <textarea class="form-control mb-2" placeholder="æ€§æ ¼ç‰¹ç‚¹" rows="4">æ´»æ³¼å¥½åŠ¨ï¼Œå–œæ¬¢è¿åŠ¨å’Œæ¸¸æˆã€‚</textarea>
                <textarea class="form-control mb-2" placeholder="å¼€åœºç™½" rows="2">ä½ å¥½ï¼æˆ‘ä»¬æ¥ç©ä¸ªæ¸¸æˆå§ï¼</textarea>
                <button class="btn btn-sm btn-danger" onclick="removeChildCard(this)"><i class="fas fa-trash"></i> åˆ é™¤</button>
            `;
            container.appendChild(childCard);
        }

        // åˆ é™¤æµ‹è¯•è§’è‰²
        function removeChildCard(button) {
            const childCard = button.closest('.child-card');
            const presetId = childCard.getAttribute('data-preset-id');
            
            if (document.querySelectorAll('.child-card').length > 1) {
                childCard.remove();
                
                // å¦‚æœæ˜¯é¢„è®¾è§’è‰²ï¼Œä»å·²æ·»åŠ é›†åˆä¸­ç§»é™¤
                if (presetId) {
                    addedChildrenIds.delete(presetId);
                    // æ›´æ–°èœå•ï¼Œè¯¥è§’è‰²å¯ä»¥å†æ¬¡æ·»åŠ 
                    updatePresetChildrenMenu();
                    console.log('âœ… å·²ç§»é™¤è§’è‰²:', presetId);
                }
            } else {
                alert('è‡³å°‘éœ€è¦ä¿ç•™ä¸€ä¸ªæµ‹è¯•è§’è‰²');
            }
        }

        // æ·»åŠ è¯„åˆ†æ ‡å‡†
        function addCriteria() {
            const container = document.getElementById('criteria-container');
            const criteriaItem = document.createElement('div');
            criteriaItem.className = 'criteria-item';
            criteriaItem.innerHTML = `
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <input type="text" class="form-control form-control-sm" style="width: 70%;" placeholder="è¯„åˆ†æ ‡å‡†åç§°" value="æ–°è¯„åˆ†æ ‡å‡†">
                    <button class="btn btn-sm btn-outline-danger" onclick="removeCriteria(this)"><i class="fas fa-trash"></i></button>
                </div>
                <textarea class="form-control" rows="3" placeholder="æè¿°å¦‚ä½•è¯„ä¼°è¿™ä¸ªæ ‡å‡†..."></textarea>
            `;
            container.appendChild(criteriaItem);
        }

        // åˆ é™¤è¯„åˆ†æ ‡å‡†
        function removeCriteria(button) {
            const criteriaItem = button.closest('.criteria-item');
            const criterionId = criteriaItem.getAttribute('data-criterion-id');
            
            if (document.querySelectorAll('.criteria-item').length > 1) {
                criteriaItem.remove();
                
                // å¦‚æœæ˜¯é¢„è®¾æ ‡å‡†ï¼Œä»å·²æ·»åŠ é›†åˆä¸­ç§»é™¤
                if (criterionId) {
                    addedCriteriaIds.delete(criterionId);
                    // æ›´æ–°èœå•ï¼Œè¯¥æ ‡å‡†å¯ä»¥å†æ¬¡æ·»åŠ 
                    updatePresetCriteriaMenu();
                    console.log('âœ… å·²ç§»é™¤è¯„åˆ†æ ‡å‡†:', criterionId);
                }
            } else {
                alert('è‡³å°‘éœ€è¦ä¿ç•™ä¸€ä¸ªè¯„åˆ†æ ‡å‡†');
            }
        }

        // è¿è¡Œæµ‹è¯•
        async function runTest() {
            // æ”¶é›†é…ç½®æ•°æ®
            const children = [];
            document.querySelectorAll('.child-card').forEach(card => {
                const inputs = card.querySelectorAll('input, textarea');
                children.push({
                    name: inputs[0].value,
                    age: parseInt(inputs[1].value),
                    traits: inputs[2].value,
                    opening: inputs[3].value
                });
            });

            // æ”¶é›†åŠ¨æ€è¯„åˆ†æ ‡å‡†
            const criteria = {};
            document.querySelectorAll('.criteria-item').forEach((item, index) => {
                const nameInput = item.querySelector('input[type="text"]');
                const textarea = item.querySelector('textarea');
                const criteriaName = nameInput.value.trim() || `è¯„åˆ†æ ‡å‡†${index + 1}`;
                criteria[criteriaName] = textarea.value;
            });

            // æ˜¾ç¤ºå®æ—¶è¿›åº¦
            showRealTimeProgress(children);

            // ä¾æ¬¡æµ‹è¯•æ¯ä¸ªè§’è‰²
            for (let i = 0; i < children.length; i++) {
                await runRealTimeTest(children[i], criteria, i);
            }
        }

        // å®æ—¶å¯¹è¯æµ‹è¯•
        async function runRealTimeTest(child, criteria, childIndex) {
            const container = document.getElementById('results-container');
            const allCards = container.querySelectorAll('.result-card');
            const currentCard = allCards[childIndex];
            const conversationContainer = currentCard.querySelector('.conversation-container');
            const progressText = currentCard.querySelector('.progress-text');
            
            let conversationId = null;
            let currentMessage = child.opening;
            const conversationLog = [];
            
            // ä¸å†ä½¿ç”¨é¢„è®¾çš„å›åº”ï¼Œè€Œæ˜¯ä½¿ç”¨Geminiç”Ÿæˆ
            
            // è·å–ç”¨æˆ·è®¾ç½®çš„è½®æ•°
            const maxRounds = getRounds();
            
            // è¿›è¡Œå¯¹è¯æµ‹è¯•
            for (let round = 1; round <= maxRounds; round++) {
                // æ˜¾ç¤ºå½“å‰è½®æ¬¡çš„è¿›åº¦
                if (progressText) {
                    progressText.innerHTML = `<i class="fas fa-spinner fa-spin"></i> æ­£åœ¨è¿›è¡Œç¬¬${round}è½®å¯¹è¯... (${round}/${maxRounds})`;
                }
                
                try {
                    // è·å–APIå¯†é’¥
                    const apiKeys = getApiKeys();
                    
                    // è°ƒç”¨å•è½®å¯¹è¯API
                    const response = await fetch('/api/test-round', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            child: child,
                            criteria: criteria,
                            round_num: round,
                            conversation_id: conversationId,
                            message: currentMessage,
                            conversation_history: conversationLog,
                            ...apiKeys
                        })
                    });
                    
                    // å…ˆæ£€æŸ¥HTTPçŠ¶æ€ç 
                    if (!response.ok) {
                        // HTTPé”™è¯¯ï¼ˆåŒ…æ‹¬500ï¼‰
                        const errorResult = await response.json();
                        console.error('ç¬¬' + round + 'è½®HTTPé”™è¯¯:', errorResult);
                        alert('âŒ æµ‹è¯•å¤±è´¥ï¼\n\n' + (errorResult.message || 'ç¬¬' + round + 'è½®å¯¹è¯å¤±è´¥') + '\n\né”™è¯¯è¯¦æƒ…: ' + (errorResult.error || 'HTTP ' + response.status));
                        
                        // éšè—åŠ è½½çŠ¶æ€
                        document.querySelector('.loading').style.display = 'none';
                        return; // åœæ­¢æµ‹è¯•
                    }
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        // æ›´æ–°å¯¹è¯ID
                        conversationId = result.conversation_id;
                        
                        // ğŸ”¥ é¢å¤–éªŒè¯ï¼šç¡®ä¿ai_responseä¸ä¸ºç©ºä¸”ä¸æ˜¯é”™è¯¯æ¶ˆæ¯
                        if (!result.ai_response || result.ai_response.trim() === '' || 
                            result.ai_response.includes('è¿æ¥å¤±è´¥') || 
                            result.ai_response.includes('APIå¤±è´¥')) {
                            console.error('ç¬¬' + round + 'è½®æ£€æµ‹åˆ°æ— æ•ˆçš„AIå›å¤:', result.ai_response);
                            alert('âŒ æµ‹è¯•å¤±è´¥ï¼\n\nç¬¬' + round + 'è½®ï¼šAIå›å¤æ— æ•ˆæˆ–ä¸ºç©º\n\nè¯·æ£€æŸ¥Difyé…ç½®');
                            document.querySelector('.loading').style.display = 'none';
                            return; // åœæ­¢æµ‹è¯•
                        }
                        
                        // è®°å½•å¯¹è¯
                        const conversation = {
                            round: result.round,
                            user_message: result.user_message,
                            ai_response: result.ai_response,
                            timestamp: result.timestamp
                        };
                        conversationLog.push(conversation);
                        
                        // å®æ—¶æ˜¾ç¤ºè¿™ä¸€è½®å¯¹è¯
                        displaySingleRound(conversationContainer, conversation);
                        
                        // å‡†å¤‡ä¸‹ä¸€è½®æ¶ˆæ¯ï¼ˆä½¿ç”¨Geminiç”Ÿæˆå­©å­å›åº”ï¼‰
                        if (round < maxRounds) {
                            try {
                                const childResponse = await fetch('/api/generate-child-response', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json'
                                    },
                                    body: JSON.stringify({
                                        child: child,
                                        ai_response: result.ai_response,
                                        round_num: round + 1,
                                        conversation_history: conversationLog,
                                        ...apiKeys
                                    })
                                });
                                
                                const childResult = await childResponse.json();
                                if (childResult.success) {
                                    currentMessage = childResult.child_response;
                                } else {
                                    currentMessage = "æˆ‘æƒ³äº†è§£æ›´å¤šï¼";
                                }
                            } catch (error) {
                                console.error('ç”Ÿæˆå­©å­å›åº”å¤±è´¥:', error);
                                currentMessage = "æˆ‘æƒ³äº†è§£æ›´å¤šï¼";
                            }
                        }
                        
                        // æ·»åŠ å»¶è¿Ÿï¼Œè®©ç”¨æˆ·èƒ½çœ‹åˆ°å®æ—¶æ•ˆæœ
                        await new Promise(resolve => setTimeout(resolve, 1000));
                    } else {
                        // Dify APIå¤±è´¥ï¼Œå¼¹å‡ºé”™è¯¯å¹¶åœæ­¢æµ‹è¯•
                        console.error('ç¬¬' + round + 'è½®å¯¹è¯å¤±è´¥:', result.message);
                        alert('âŒ æµ‹è¯•å¤±è´¥ï¼\n\n' + result.message + '\n\né”™è¯¯è¯¦æƒ…: ' + (result.error || 'æœªçŸ¥é”™è¯¯'));
                        
                        // éšè—åŠ è½½çŠ¶æ€
                        document.querySelector('.loading').style.display = 'none';
                        return; // åœæ­¢æµ‹è¯•
                    }
                } catch (error) {
                    console.error('ç¬¬' + round + 'è½®å¯¹è¯å‡ºé”™:', error);
                    alert('âŒ ç½‘ç»œé”™è¯¯ï¼\n\nç¬¬' + round + 'è½®å¯¹è¯è¯·æ±‚å¤±è´¥\n\né”™è¯¯è¯¦æƒ…: ' + error.message);
                    
                    // éšè—åŠ è½½çŠ¶æ€
                    document.querySelector('.loading').style.display = 'none';
                    return; // åœæ­¢æµ‹è¯•
                }
            }
            
            // æ‰€æœ‰å¯¹è¯å®Œæˆåï¼Œè¿›è¡Œè¯„åˆ†
            await performFinalEvaluation(child, criteria, conversationLog, conversationContainer, progressText);
        }

        // æ˜¾ç¤ºå•è½®å¯¹è¯
        function displaySingleRound(container, conversation) {
            const roundHtml = `
                <div class="conversation-round mb-3 p-3 rounded" style="background-color: white; border-left: 4px solid #007bff;">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <strong>ç¬¬${conversation.round}è½®</strong>
                        <small class="text-muted">${conversation.timestamp}</small>
                    </div>
                    <div class="mb-2">
                        <strong>å­©å­ï¼š</strong><span class="text-primary">${conversation.user_message}</span>
                    </div>
                    <div>
                        <strong>AIï¼š</strong><span class="text-success">${conversation.ai_response}</span>
                    </div>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', roundHtml);
            
            // æ»šåŠ¨åˆ°æœ€æ–°å†…å®¹
            container.scrollTop = container.scrollHeight;
        }

        // æ‰§è¡Œæœ€ç»ˆè¯„åˆ†
        async function performFinalEvaluation(child, criteria, conversationLog, conversationContainer, progressText) {
            // æ˜¾ç¤ºè¯„åˆ†ä¸­çŠ¶æ€
            if (progressText) {
                progressText.innerHTML = '<i class="fas fa-spinner fa-spin"></i> æ­£åœ¨è¿›è¡Œæœ€ç»ˆè¯„åˆ†...';
            }
            
            try {
                // è·å–APIå¯†é’¥
                const apiKeys = getApiKeys();
                
                // è°ƒç”¨åç«¯è¯„åˆ†API
                const response = await fetch('/api/evaluate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        child: child,
                        conversation_history: conversationLog,
                        criteria: criteria,
                        ...apiKeys
                    })
                });
                
                const evalResult = await response.json();
                
                const result = {
                    child: child.name,
                    age: child.age,
                    traits: child.traits,
                    opening: child.opening,
                    conversation_log: conversationLog,
                    scores: evalResult.scores || {},
                    score_details: evalResult.score_details || {},
                    reason: evalResult.reason || "è¯„åˆ†å®Œæˆ",
                    lessons: evalResult.lessons || "æš‚æ— ç»éªŒæ•™è®­",
                    character_review: evalResult.character_review || "",
                    timestamp: new Date().toLocaleString()
                };
                
                // æ˜¾ç¤ºæœ€ç»ˆç»“æœ
                displayFinalResults(conversationContainer, result, progressText);
                
                // ä¿å­˜åˆ°CSV
                await saveResultToCSV(child, criteria, conversationLog, evalResult.scores, evalResult.reason, evalResult.lessons, evalResult.character_review);
                
            } catch (error) {
                console.error('è¯„åˆ†è¿‡ç¨‹å‡ºé”™:', error);
                // å¦‚æœè¯„åˆ†å¤±è´¥ï¼Œä»ç„¶æ˜¾ç¤ºå¯¹è¯è®°å½•
                const result = {
                    child: child.name,
                    age: child.age,
                    traits: child.traits,
                    opening: child.opening,
                    conversation_log: conversationLog,
                    scores: {},
                    score_details: {},
                    reason: "è¯„åˆ†è¿‡ç¨‹å‡ºé”™ï¼š" + error.message,
                    lessons: "è¯„åˆ†å¤±è´¥ï¼Œæ— æ³•ç”Ÿæˆç»éªŒæ•™è®­",
                    character_review: "",
                    timestamp: new Date().toLocaleString()
                };
                displayFinalResults(conversationContainer, result, progressText);
                
                // å³ä½¿è¯„åˆ†å¤±è´¥ï¼Œä¹Ÿä¿å­˜å¯¹è¯è®°å½•åˆ°CSV
                await saveResultToCSV(child, criteria, conversationLog, {}, "è¯„åˆ†è¿‡ç¨‹å‡ºé”™ï¼š" + error.message, "", "");
            }
        }

        // æ˜¾ç¤ºæœ€ç»ˆç»“æœ
        function displayFinalResults(container, result, progressText) {
            const scores = result.scores || {};
            const scoreDetails = result.score_details || {};
            const scoreKeys = Object.keys(scores);
            
            // ç”Ÿæˆæ¯ä¸ªè¯„åˆ†æ ‡å‡†çš„è¯¦ç»†å¡ç‰‡
            const scoreDetailsHtml = scoreKeys.map((key, i) => {
                const score = scores[key] || 0;
                let detail = scoreDetails[key] || 'æš‚æ— è¯¦ç»†ç†ç”±';
                // ç¡®ä¿detailæ˜¯å­—ç¬¦ä¸²
                if (typeof detail !== 'string') {
                    detail = String(detail) || 'æš‚æ— è¯¦ç»†ç†ç”±';
                }
                const colors = ['primary', 'success', 'warning', 'info', 'danger', 'secondary', 'dark'];
                const color = colors[i % colors.length];
                
                // æ ¹æ®åˆ†æ•°é€‰æ‹©å›¾æ ‡
                let icon = 'fa-star';
                if (score >= 9) icon = 'fa-star text-warning';
                else if (score >= 7) icon = 'fa-check-circle text-success';
                else if (score >= 5) icon = 'fa-minus-circle text-primary';
                else icon = 'fa-times-circle text-danger';
                
                return `
                    <div class="card mb-2">
                        <div class="card-header bg-${color} text-white d-flex justify-content-between align-items-center">
                            <span><i class="fas ${icon}"></i> ${key}</span>
                            <span class="badge bg-light text-dark">${score} åˆ†</span>
                        </div>
                        <div class="card-body">
                            <small style="white-space: pre-wrap;">${detail}</small>
                        </div>
                    </div>
                `;
            }).join('');
            
            // æ ¼å¼åŒ–ç»éªŒæ•™è®­ï¼ˆä¿ç•™æ¢è¡Œå’Œåˆ—è¡¨æ ¼å¼ï¼‰
            // ç¡®ä¿lessonsæ˜¯å­—ç¬¦ä¸²ç±»å‹
            let lessonsText = result.lessons || 'æ— ';
            if (typeof lessonsText !== 'string') {
                lessonsText = JSON.stringify(lessonsText) || 'æ— ';
            }
            const lessonsFormatted = lessonsText.replace(/\n/g, '<br>');
            
            // ç¡®ä¿reasonä¹Ÿæ˜¯å­—ç¬¦ä¸²
            let reasonText = result.reason || 'æ— ';
            if (typeof reasonText !== 'string') {
                reasonText = String(reasonText) || 'æ— ';
            }
            
            // ç¡®ä¿character_reviewä¹Ÿæ˜¯å­—ç¬¦ä¸²
            let characterReviewText = result.character_review || '';
            if (typeof characterReviewText !== 'string') {
                characterReviewText = String(characterReviewText) || '';
            }
            const characterReviewFormatted = characterReviewText.replace(/\n/g, '<br>');
            
            // åªæœ‰å½“æœ‰è§’è‰²è‡ªè¿°æ—¶æ‰æ˜¾ç¤ºè§’è‰²è‡ªè¿°å¡ç‰‡
            const characterReviewHtml = characterReviewText ? `
                <div class="card border-success mb-2">
                    <div class="card-header bg-success text-white">
                        <i class="fas fa-child"></i> è§’è‰²è‡ªè¿°ï¼ˆ${result.child}çš„æ„Ÿå—ï¼‰
                    </div>
                    <div class="card-body" style="background-color: #f0f8ff;">
                        <small style="white-space: pre-wrap; font-style: italic;">"${characterReviewFormatted}"</small>
                    </div>
                </div>
            ` : '';
            
            const finalHtml = `
                <div class="mt-4">
                    <h6 class="mb-3"><i class="fas fa-star"></i> ğŸ“Š è¯¦ç»†è¯„åˆ†ç»“æœ</h6>
                    ${scoreDetailsHtml}
                    
                    <div class="card mb-2 border-info">
                        <div class="card-header bg-info text-white">
                            <i class="fas fa-lightbulb"></i> æ€»ä½“è¯„ä»·
                        </div>
                        <div class="card-body">
                            <small style="white-space: pre-wrap;">${reasonText}</small>
                        </div>
                    </div>
                    
                    <div class="card border-warning mb-2">
                        <div class="card-header bg-warning text-dark">
                            <i class="fas fa-book"></i> ç»éªŒæ•™è®­
                        </div>
                        <div class="card-body">
                            <small style="white-space: pre-wrap;">${lessonsFormatted}</small>
                        </div>
                    </div>
                    
                    ${characterReviewHtml}
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', finalHtml);
            
            // æ›´æ–°è¿›åº¦æ–‡æœ¬
            if (progressText) {
                progressText.innerHTML = '<i class="fas fa-check-circle"></i> æµ‹è¯•å®Œæˆï¼';
            }
        }

        // ä¿å­˜ç»“æœåˆ°CSV
        async function saveResultToCSV(child, criteria, conversationLog, scores, reason, lessons, character_review) {
            try {
                const response = await fetch('/api/save-result', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        child: child,
                        criteria: criteria,
                        conversations: conversationLog,
                        scores: scores || {},
                        reason: reason || '',
                        lessons: lessons || '',
                        character_review: character_review || '',
                        timestamp: new Date().toLocaleString('zh-CN', {
                            year: 'numeric',
                            month: '2-digit',
                            day: '2-digit',
                            hour: '2-digit',
                            minute: '2-digit',
                            second: '2-digit'
                        })
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    console.log('âœ… æµ‹è¯•ç»“æœå·²ä¿å­˜åˆ°CSV');
                } else {
                    console.error('âŒ ä¿å­˜CSVå¤±è´¥:', result.message);
                }
            } catch (error) {
                console.error('âŒ ä¿å­˜CSVå‡ºé”™:', error);
            }
        }

        // æ˜¾ç¤ºå®æ—¶è¿›åº¦
        function showRealTimeProgress(children) {
            const container = document.getElementById('results-container');
            const maxRounds = getRounds();
            let html = '<div class="row">';
            
            children.forEach((child, index) => {
                html += `
                    <div class="col-md-12 mb-4">
                        <div class="card result-card">
                            <div class="card-header">
                                <h5><i class="fas fa-child"></i> ${child.name} (${child.age}å²) - ${maxRounds}è½®å¯¹è¯</h5>
                            </div>
                            <div class="card-body">
                                <p><strong>æ€§æ ¼ç‰¹ç‚¹ï¼š</strong>${child.traits}</p>
                                <p><strong>å¼€åœºç™½ï¼š</strong>${child.opening}</p>
                                <hr>
                                <h6><i class="fas fa-comments"></i> å¯¹è¯è®°å½•ï¼š</h6>
                                <div class="progress-text text-center text-primary mb-3">
                                    <i class="fas fa-spinner fa-spin"></i> å‡†å¤‡å¼€å§‹å¯¹è¯æµ‹è¯•...
                                </div>
                                <div class="conversation-container" style="max-height: 400px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 5px; padding: 15px; background-color: #f8f9fa;">
                                    <div class="text-center text-muted">
                                        <p>ç­‰å¾…å¯¹è¯å¼€å§‹...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }

        // å­˜å‚¨å½“å‰ç»“æœ
        let currentResults = [];

        // æ˜¾ç¤ºç»“æœ
        function displayResults(results) {
            currentResults = results; // ä¿å­˜ç»“æœ
            const container = document.getElementById('results-container');
            const maxRounds = getRounds();
            let html = '<div class="row">';
            
            results.forEach((result, index) => {
                const scores = result.scores || {};
                const scoreKeys = Object.keys(scores);
                const conversationLog = result.conversation_log || [];
                
                html += `
                    <div class="col-md-12 mb-4">
                        <div class="card result-card">
                            <div class="card-header">
                                <h5><i class="fas fa-child"></i> ${result.child} (${result.age}å²) - ${maxRounds}è½®å¯¹è¯</h5>
                            </div>
                            <div class="card-body">
                                <p><strong>æ€§æ ¼ç‰¹ç‚¹ï¼š</strong>${result.traits}</p>
                                <p><strong>å¼€åœºç™½ï¼š</strong>${result.opening}</p>
                                <hr>
                                <h6><i class="fas fa-comments"></i> å¯¹è¯è®°å½•ï¼š</h6>
                                <div class="conversation-container" style="max-height: 400px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 5px; padding: 15px; background-color: #f8f9fa;">
                `;
                
                // æ˜¾ç¤ºæ¯è½®å¯¹è¯
                conversationLog.forEach((conversation, roundIndex) => {
                    html += `
                        <div class="conversation-round mb-3 p-3 rounded" style="background-color: white; border-left: 4px solid #007bff;">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <strong>ç¬¬${conversation.round}è½®</strong>
                                <small class="text-muted">${conversation.timestamp}</small>
                            </div>
                            <div class="mb-2">
                                <strong>å­©å­ï¼š</strong><span class="text-primary">${conversation.user_message}</span>
                            </div>
                            <div>
                                <strong>AIï¼š</strong><span class="text-success">${conversation.ai_response}</span>
                            </div>
                        </div>
                    `;
                });
                
                html += `
                                </div>
                                <hr>
                                <div class="row text-center">
                `;
                
                // åŠ¨æ€æ˜¾ç¤ºè¯„åˆ†
                scoreKeys.forEach((key, i) => {
                    const colors = ['bg-primary', 'bg-success', 'bg-warning', 'bg-info', 'bg-danger', 'bg-secondary'];
                    const color = colors[i % colors.length];
                    html += `
                        <div class="col-${Math.floor(12 / scoreKeys.length)}">
                            <span class="badge ${color} score-badge">${key}: ${scores[key] || 0}</span>
                        </div>
                    `;
                });
                
                html += `
                                </div>
                                <p class="mt-2"><small class="text-muted">${result.reason}</small></p>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }

        // æ¸…ç©ºç»“æœ
        function clearResults() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰ç»“æœå—ï¼Ÿ')) {
                currentResults = [];
                document.getElementById('results-container').innerHTML = `
                    <div class="text-center text-muted">
                        <i class="fas fa-clipboard-list fa-3x mb-3"></i>
                        <p>é…ç½®æµ‹è¯•è§’è‰²å’Œè¯„åˆ†æ ‡å‡†ï¼Œç„¶åç‚¹å‡»"å¼€å§‹æµ‹è¯•"</p>
                    </div>
                `;
            }
        }
    </script>
</body>
</html>
