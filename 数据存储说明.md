# 📊 数据存储说明

## 🎯 概述

测试结果采用 **双格式存储**：
- **JSON文件**：保存完整的结构化数据，便于程序读取和处理
- **CSV文件**：保存简化数据，便于Excel查看和快速分析

---

## 📁 文件说明

### 1️⃣ JSON 文件：`test_results.json`

**用途：** 完整的结构化数据存储

**格式：** JSON数组，每个元素是一条测试记录

**特点：**
- ✅ 保存完整的对话记录
- ✅ 结构化的评分数据
- ✅ 详细的统计信息
- ✅ 便于程序读取和分析
- ✅ 支持复杂查询和数据处理

**示例结构：**

```json
[
  {
    "test_id": "20251018_150000_小熊",
    "timestamp": "2025-10-18 15:00:00",
    "test_date": "2025-10-18",
    "child": {
      "name": "小熊",
      "age": 5,
      "type": "害羞型",
      "traits": "## 角色性格\n- 性格比较害羞...",
      "opening": "Hello... I'm shy."
    },
    "conversations": [
      {
        "user_message": "Hello... I'm shy.",
        "ai_response": "Hi there! It's okay to be shy..."
      },
      {
        "user_message": "I like cats.",
        "ai_response": "That's wonderful! Cats are amazing..."
      }
    ],
    "rounds": 3,
    "scores": {
      "individual": {
        "开口勇气": 6,
        "主动表达": 5,
        "情绪回应": 7
      },
      "average": 6.0,
      "max": 7,
      "min": 5,
      "std_dev": 0.82,
      "criteria_used": ["开口勇气", "主动表达", "情绪回应"]
    },
    "evaluation": {
      "reason": "从孩子的角度看，AI的主要问题是...",
      "lessons": "【改进建议】分条列出：\n1. ❌ 主要问题...",
      "character_review": "我觉得...有点..."
    },
    "statistics": {
      "total_chars_child": 45,
      "total_chars_ai": 180,
      "avg_chars_child": 15.0,
      "avg_chars_ai": 60.0
    }
  }
]
```

**数据字典：**

| 字段路径 | 类型 | 说明 |
|---------|------|------|
| `test_id` | String | 唯一测试标识符 |
| `timestamp` | DateTime | 完整时间戳 |
| `test_date` | Date | 测试日期 |
| `child.name` | String | 角色名称 |
| `child.age` | Integer | 角色年龄 |
| `child.type` | String | 角色类型 |
| `child.traits` | String | 完整性格设定 |
| `child.opening` | String | 开场白 |
| `conversations[].user_message` | String | 孩子消息 |
| `conversations[].ai_response` | String | AI回复 |
| `rounds` | Integer | 对话轮数 |
| `scores.individual` | Object | 各项评分详情 |
| `scores.average` | Float | 平均分 |
| `scores.max` | Integer | 最高分 |
| `scores.min` | Integer | 最低分 |
| `scores.std_dev` | Float | 标准差 |
| `scores.criteria_used` | Array | 使用的评分标准列表 |
| `evaluation.reason` | String | 评分总体理由 |
| `evaluation.lessons` | String | 经验教训 |
| `evaluation.character_review` | String | 角色自述 |
| `statistics.total_chars_child` | Integer | 孩子总字数 |
| `statistics.total_chars_ai` | Integer | AI总字数 |
| `statistics.avg_chars_child` | Float | 孩子平均字数 |
| `statistics.avg_chars_ai` | Float | AI平均字数 |

---

### 2️⃣ CSV 文件：`test_results.csv`

**用途：** 简化数据，便于Excel查看

**格式：** 标准CSV，UTF-8 with BOM编码

**特点：**
- ✅ 固定列结构（52列）
- ✅ Excel完美兼容
- ✅ 评分数据用JSON字符串存储
- ✅ 便于快速浏览和基础统计
- ✅ 支持数据透视表

**列结构：**

#### 基础信息（7列）
| 列名 | 类型 | 说明 |
|------|------|------|
| 测试ID | String | 唯一标识符 |
| 测试时间 | DateTime | 完整时间戳 |
| 测试日期 | Date | 日期（YYYY-MM-DD） |
| 角色名称 | String | 角色名 |
| 角色类型 | String | 害羞型/话多型等 |
| 角色年龄 | Integer | 年龄 |
| 对话轮数 | Integer | 实际轮数 |

#### 对话内容（1列，JSON格式）
| 列名 | 类型 | 说明 |
|------|------|------|
| 对话记录_JSON | String(JSON) | **所有对话轮次（JSON数组）** |

> **JSON格式示例：**
> ```json
> [
>   {"round": 1, "child_message": "Hello...", "ai_response": "Hi there!", "child_chars": 8, "ai_chars": 10},
>   {"round": 2, "child_message": "I like cats.", "ai_response": "That's wonderful!", "child_chars": 13, "ai_chars": 16},
>   {"round": 3, "child_message": "Tell me more.", "ai_response": "Sure! Cats are...", "child_chars": 14, "ai_chars": 17}
> ]
> ```

#### 评分数据（6列）
| 列名 | 类型 | 说明 |
|------|------|------|
| 评分详情_JSON | String(JSON) | **各项评分（JSON格式）** |
| 评分_平均分 | Float | 平均分 |
| 评分_最高分 | Integer | 最高分 |
| 评分_最低分 | Integer | 最低分 |
| 评分_标准差 | Float | 标准差 |
| 使用的评分标准 | String | 标准列表（逗号分隔） |

> **重要：** `评分详情_JSON` 列存储的是JSON字符串，如：`{"开口勇气": 6, "主动表达": 5, "情绪回应": 7}`
> 
> 在Excel中可以：
> - 直接查看原始JSON
> - 使用Excel的Power Query解析JSON
> - 使用Python/R读取并解析

#### 对话统计（4列）
| 列名 | 类型 | 说明 |
|------|------|------|
| 总字数_孩子 | Integer | 孩子总字数 |
| 总字数_AI | Integer | AI总字数 |
| 平均字数_孩子 | Float | 平均每轮字数 |
| 平均字数_AI | Float | 平均每轮字数 |

#### 评价内容（3列）
| 列名 | 类型 | 说明 |
|------|------|------|
| 评分理由_总体 | Text | 总体评价 |
| 经验教训 | Text | 改进建议 |
| 角色自述 | Text | 角色视角评价 |

#### 元数据（2列）
| 列名 | 类型 | 说明 |
|------|------|------|
| 角色完整设定 | Text | 完整traits |
| 开场白 | String | opening |

**总列数：** 7 + 1 + 7 + 4 + 3 + 2 = **14列（固定）**

> ✨ **重大简化：** 原40列对话数据现在合并为1列JSON，避免大量空列！

---

## 📈 使用场景对比

### JSON 适用场景

1. **程序化数据处理**
   ```python
   import json
   with open('test_results.json', 'r', encoding='utf-8') as f:
       data = json.load(f)
   
   # 直接访问结构化数据
   for record in data:
       print(f"{record['child']['name']}: {record['scores']['average']}")
   ```

2. **复杂查询**
   ```python
   # 找出所有害羞型角色的平均分
   shy_scores = [r['scores']['average'] for r in data 
                 if r['child']['type'] == '害羞型']
   ```

3. **数据导出和集成**
   - 便于导入到数据库
   - 便于API接口传输
   - 便于与其他系统集成

### CSV 适用场景

1. **Excel快速查看**
   - 直接双击打开
   - 使用筛选功能
   - 创建图表

2. **数据透视表**
   ```
   按角色类型分组 → 平均评分
   按日期分组 → 趋势分析
   ```

3. **快速统计**
   - SUM、AVERAGE、MAX、MIN
   - 条件格式化
   - 简单图表

4. **JSON列解析示例**
   
   **解析对话记录：**
   ```python
   import pandas as pd
   import json
   
   df = pd.read_csv('test_results.csv', encoding='utf-8-sig')
   
   # 解析对话JSON
   df['对话记录'] = df['对话记录_JSON'].apply(json.loads)
   
   # 提取第一轮对话
   df['第1轮_孩子'] = df['对话记录'].apply(lambda x: x[0]['child_message'] if len(x) > 0 else '')
   df['第1轮_AI'] = df['对话记录'].apply(lambda x: x[0]['ai_response'] if len(x) > 0 else '')
   
   # 或者展开所有对话为单独的行
   conversations_df = df.explode('对话记录')
   conversations_df['round'] = conversations_df['对话记录'].apply(lambda x: x['round'])
   conversations_df['child_message'] = conversations_df['对话记录'].apply(lambda x: x['child_message'])
   conversations_df['ai_response'] = conversations_df['对话记录'].apply(lambda x: x['ai_response'])
   ```
   
   **解析评分详情：**
   ```python
   # 解析评分JSON
   df['评分详情'] = df['评分详情_JSON'].apply(json.loads)
   
   # 展开为独立列
   scores_df = pd.json_normalize(df['评分详情'])
   df = pd.concat([df, scores_df], axis=1)
   ```

---

## 🔄 数据同步

**保存流程：**

1. 前端完成测试并调用 `/api/save-result`
2. 后端同时保存到：
   - `test_results.json`（追加模式，完整数据）
   - `test_results.csv`（追加模式，简化数据）
3. 返回成功消息

**一致性保证：**
- 使用线程锁（`file_lock`）确保并发安全
- 两个文件使用相同的 `test_id` 关联
- 如果一个保存失败，另一个仍会保存

---

## 💡 最佳实践

### 日常使用建议

1. **快速查看 → 使用 CSV**
   - 用Excel打开查看最近测试
   - 使用筛选功能查找特定角色
   - 创建简单的图表

2. **深度分析 → 使用 JSON**
   - Python/R脚本进行数据分析
   - 创建自定义统计报告
   - 导入到数据库做复杂查询

3. **评分详情分析**
   - **简单查看：** 在CSV中直接看JSON字符串
   - **详细分析：** 用Python解析JSON列
   - **全面分析：** 直接读取JSON文件

### Excel中解析评分详情

**方法1：Power Query**
1. 打开CSV文件
2. 选择 `评分详情_JSON` 列
3. 数据 → 从文本/CSV → JSON
4. 展开为列

**方法2：Python脚本**
```python
import pandas as pd
import json

# 读取CSV
df = pd.read_csv('test_results.csv', encoding='utf-8-sig')

# 解析评分JSON
def parse_scores(json_str):
    try:
        return json.loads(json_str)
    except:
        return {}

df['评分详情'] = df['评分详情_JSON'].apply(parse_scores)

# 展开为独立列
scores_df = pd.json_normalize(df['评分详情'])
result = pd.concat([df.drop('评分详情', axis=1), scores_df], axis=1)

# 保存为新的CSV（带评分列）
result.to_csv('test_results_expanded.csv', index=False, encoding='utf-8-sig')
```

---

## 📝 数据备份建议

1. **定期备份**
   - JSON文件：完整备份
   - CSV文件：可选备份

2. **版本控制**
   - 使用日期命名备份文件
   - 例如：`test_results_20251018.json`

3. **云端同步**
   - 定期上传到云存储
   - 防止数据丢失

---

## 🔗 相关文档

- `CSV数据字典.md` - CSV详细列名说明
- `preset_children.json` - 角色配置
- `preset_criteria.json` - 评分标准配置
- `如何添加内置角色.md` - 角色添加指南
- `如何添加内置评分标准.md` - 评分标准指南

---

**文件位置：** `d:\test_agent\`  
**最后更新：** 2025-10-18  
**版本：** 2.0 (JSON + CSV双格式)

